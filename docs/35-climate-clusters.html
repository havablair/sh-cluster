<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Minnesota Topsoil Classification for Soil Health Assessment - 17&nbsp; Cluster map units based on climate</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./19-sample-points.html" rel="next">
<link href="./32-sample-climate-vars.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>



</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./35-climate-clusters.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Cluster map units based on climate</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Minnesota Topsoil Classification for Soil Health Assessment</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data_sources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data Sources</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-mus_comp_in_aoi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Explore Map Units &amp; Components in AOI</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-subset-component-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Identify Target Components</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-horiz-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Horizon Data Averages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-soil-prop-eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Soil Property Exploratory Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-map-unit-agg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Map unit aggregation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-var-transformations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Variable Transformations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-plot-ec-lep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">MAP EC and LEP with <code>{terra}</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-additional-data-prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Additional Data Preparation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-implement-kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Implement k-means</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22-pca-kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Do PCA before k-means</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23-pca-kmeans-finalists.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Clustering Finalists</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24-compare-kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Comparing k-means scenarios</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26-notes-pca6-8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Comparing PCA 6 &amp; PCA 8 Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31-demo-weighted-centroids.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Find map unit weighted centroids</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32-sample-climate-vars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Sample climate data at map-unit centroids</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35-climate-clusters.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Cluster map units based on climate</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19-sample-points.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Sample validation points</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./29-welch-pairwise.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Welch ANOVA for PCA cluster pairwise comparisons</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36-update-welch-compare-variation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Welch ANOVA - compare variation explained</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">17.1</span> Overview</a></li>
  <li><a href="#set-up" id="toc-set-up" class="nav-link" data-scroll-target="#set-up"><span class="header-section-number">17.2</span> Set up</a></li>
  <li><a href="#pre-process-data-build-recipe" id="toc-pre-process-data-build-recipe" class="nav-link" data-scroll-target="#pre-process-data-build-recipe"><span class="header-section-number">17.3</span> Pre-process data (build recipe)</a></li>
  <li><a href="#set-model-options" id="toc-set-model-options" class="nav-link" data-scroll-target="#set-model-options"><span class="header-section-number">17.4</span> Set model options</a></li>
  <li><a href="#set-up-data-structure" id="toc-set-up-data-structure" class="nav-link" data-scroll-target="#set-up-data-structure"><span class="header-section-number">17.5</span> Set up data structure</a></li>
  <li><a href="#specify-model-for-each-value-of-k" id="toc-specify-model-for-each-value-of-k" class="nav-link" data-scroll-target="#specify-model-for-each-value-of-k"><span class="header-section-number">17.6</span> Specify model (for each value of k)</a></li>
  <li><a href="#fit-the-models" id="toc-fit-the-models" class="nav-link" data-scroll-target="#fit-the-models"><span class="header-section-number">17.7</span> Fit the models</a>
  <ul class="collapse">
  <li><a href="#view-messages-warnings" id="toc-view-messages-warnings" class="nav-link" data-scroll-target="#view-messages-warnings"><span class="header-section-number">17.7.1</span> View messages &amp; warnings</a></li>
  </ul></li>
  <li><a href="#model-metrics" id="toc-model-metrics" class="nav-link" data-scroll-target="#model-metrics"><span class="header-section-number">17.8</span> Model metrics</a>
  <ul class="collapse">
  <li><a href="#extract-metrics" id="toc-extract-metrics" class="nav-link" data-scroll-target="#extract-metrics"><span class="header-section-number">17.8.1</span> Extract metrics</a></li>
  <li><a href="#plot-total-wss" id="toc-plot-total-wss" class="nav-link" data-scroll-target="#plot-total-wss"><span class="header-section-number">17.8.2</span> Plot Total WSS</a></li>
  <li><a href="#average-silhouette" id="toc-average-silhouette" class="nav-link" data-scroll-target="#average-silhouette"><span class="header-section-number">17.8.3</span> Average Silhouette</a></li>
  <li><a href="#calinski-harabasz-index" id="toc-calinski-harabasz-index" class="nav-link" data-scroll-target="#calinski-harabasz-index"><span class="header-section-number">17.8.4</span> Calinski-Harabasz index</a></li>
  <li><a href="#wss-and-silhouette-metrics-on-one-plot" id="toc-wss-and-silhouette-metrics-on-one-plot" class="nav-link" data-scroll-target="#wss-and-silhouette-metrics-on-one-plot"><span class="header-section-number">17.8.5</span> WSS and Silhouette metrics on one plot</a></li>
  </ul></li>
  <li><a href="#save-model-fits" id="toc-save-model-fits" class="nav-link" data-scroll-target="#save-model-fits"><span class="header-section-number">17.9</span> Save model fits</a></li>
  <li><a href="#save-cluster-assignments" id="toc-save-cluster-assignments" class="nav-link" data-scroll-target="#save-cluster-assignments"><span class="header-section-number">17.10</span> Save cluster assignments</a></li>
  <li><a href="#map-clusters" id="toc-map-clusters" class="nav-link" data-scroll-target="#map-clusters"><span class="header-section-number">17.11</span> Map clusters</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Cluster map units based on climate</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>One of the comments we received from reviewers of this manuscript is that our clustering strategy does not explicitly consider climate. I explored what it would look like to include climate variables (MAT, MAP) along with soil properties when clustering. Initial interpretation of the results (see <code>_refs/alluvial_compare_k78_clim.pdf</code>) is that including climate variables results in clusters with greater heterogeneity in <strong>soil</strong> properties relative to the original versions(s), which is the opposite of what we want.</p>
<p>After Nic and I talked through this on March 8, 2024 one potential solution we discussed was to use the climate variables as another level of clustering, on top of the existing soil clusters. The idea is to use k-means to cluster by climate variables alone (using representative MAP and MAT values for each map unit), and then use soil cluster nested in climate cluster as our grouping scheme.</p>
<section id="overview" class="level2" data-number="17.1">
<h2 data-number="17.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">17.1</span> Overview</h2>
<p>Quick outline of the process:</p>
<ol type="1">
<li>Already have the data we need (MAP, MAT) from <code>31-demo-weighted-centroids.qmd</code> and <code>32-sample-climate-vars.qmd</code> , make some plots to show the distributions</li>
<li>Pre-process data (standardize), subtracting the mean and dividing by 1 sd</li>
<li>PCA doesn’t seem necessary here because we only have 2 variables (MAT and MAP)</li>
<li>Specify model options, set up data structure and k-means recipe</li>
<li>Fit models (probably k = 2-5 is reasonable to start?)</li>
<li>Evaluate results</li>
</ol>
</section>
<section id="set-up" class="level2" data-number="17.2">
<h2 data-number="17.2" class="anchored" data-anchor-id="set-up"><span class="header-section-number">17.2</span> Set up</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'workflows' was built under R version 4.3.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parsnip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'parsnip' was built under R version 4.3.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.2     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidymodels' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 1.1.1 ──
✔ broom        1.0.5      ✔ rsample      1.2.0 
✔ dials        1.2.0      ✔ tune         1.1.2 
✔ infer        1.0.6      ✔ workflowsets 1.0.1 
✔ modeldata    1.3.0      ✔ yardstick    1.2.0 
✔ recipes      1.0.10     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'broom' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'dials' was built under R version 4.3.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'scales' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'infer' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'modeldata' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'recipes' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'rsample' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tune' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'workflowsets' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'yardstick' was built under R version 4.3.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ scales::discard() masks purrr::discard()
✖ dplyr::filter()   masks stats::filter()
✖ recipes::fixed()  masks stringr::fixed()
✖ dplyr::lag()      masks stats::lag()
✖ yardstick::spec() masks readr::spec()
✖ recipes::step()   masks stats::step()
• Dig deeper into tidy modeling with R at https://www.tmwr.org</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyclust)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidyclust' was built under R version 4.3.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra) <span class="co"># trying fviz_nbclust(), which gives elbow, silhouette, and gap statistic</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'factoextra' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Welcome! Want to learn more? See two factoextra-related books at https://goo.gl/ve3WBa</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hopkins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'hopkins' was built under R version 4.3.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fpc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'fpc' was built under R version 4.3.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggforce)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggforce' was built under R version 4.3.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'gt' was built under R version 4.3.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'sf' was built under R version 4.3.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.11.2, GDAL 3.6.2, PROJ 9.2.0; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ann_normals_precip_temp_mukey_centroids.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ID) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 7861 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (6): mukey_short, ID, anntavg_norm, annprcp_norm, x, y

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>mukeys_include <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/clean_mu_weighted_soil_props_with_sand.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 6872 Columns: 12
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (12): mukey, claytotal_r_value, sandtotal_r_value, om_r_value, cec7_r_va...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for translating MUKEY from gSSURGO to my shortened version</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>cwalk <span class="ot">&lt;-</span> aoi_mu <span class="ot">&lt;-</span> <span class="fu">read.delim</span>(<span class="st">"data/gSSURGO_MN/mukey_new_crosswalk.txt"</span>, <span class="at">sep =</span> <span class="st">","</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(MUKEY, MUKEY_New)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>d_ids <span class="ot">&lt;-</span> <span class="fu">left_join</span>(d, cwalk, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"mukey_short"</span> <span class="ot">=</span> <span class="st">"MUKEY_New"</span>))</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>d_incl <span class="ot">&lt;-</span> d_ids <span class="sc">%&gt;%</span> </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MUKEY <span class="sc">%in%</span> mukeys_include<span class="sc">$</span>mukey) <span class="sc">%&gt;%</span> </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">mukey =</span> MUKEY)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check out the MAP and MAT data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d_incl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mukey_short"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["anntavg_norm"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["annprcp_norm"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["x"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["mukey"],"name":[6],"type":["int"],"align":["right"]}],"data":[{"1":"1","2":"4.260208","3":"615.0141","4":"-95.93896","5":"47.60462","6":"352159"},{"1":"3","2":"4.222908","3":"616.6034","4":"-95.81576","5":"47.62088","6":"352162"},{"1":"4","2":"4.239684","3":"615.6403","4":"-95.89229","5":"47.60323","6":"352165"},{"1":"5","2":"4.258387","3":"618.3381","4":"-95.87288","5":"47.57107","6":"352166"},{"1":"6","2":"4.261423","3":"617.1620","4":"-95.90152","5":"47.58172","6":"352171"},{"1":"7","2":"4.192676","3":"614.4951","4":"-95.78449","5":"47.65950","6":"352174"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> d_incl) <span class="sc">+</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> annprcp_norm)) <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Distribution of precipitation (mm) values"</span>) <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Annual precipitation normal (mm)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> d_incl) <span class="sc">+</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> anntavg_norm)) <span class="sc">+</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Distribution of temperature (degree Celsius) values"</span>) <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Annual temperature normal (degrees C)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-1-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check for missing values</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>d_incl <span class="sc">%&gt;%</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(annprcp_norm) <span class="sc">|</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">is.na</span>(anntavg_norm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mukey_short"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["anntavg_norm"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["annprcp_norm"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["x"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["mukey"],"name":[6],"type":["int"],"align":["right"]}],"data":[],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="pre-process-data-build-recipe" class="level2" data-number="17.3">
<h2 data-number="17.3" class="anchored" data-anchor-id="pre-process-data-build-recipe"><span class="header-section-number">17.3</span> Pre-process data (build recipe)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>rec_spec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> d_incl) <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update_role</span>(mukey, <span class="at">new_role =</span> <span class="st">"ID_long"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(mukey_short, <span class="at">new_role =</span> <span class="st">"ID_short"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="fu">c</span>(x, y), <span class="at">new_role =</span> <span class="st">"lat_lon"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>rec_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 2
lat_lon:   2
ID_long:   1
ID_short:  1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Centering and scaling for: all_numeric_predictors()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># confirm all predictors are labelled with role = predictor,</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># other vars should have other roles so they aren't included</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co"># in the model.</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rec_spec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["variable"],"name":[1],"type":["chr"],"align":["left"]},{"label":["type"],"name":[2],"type":["list"],"align":["right"]},{"label":["role"],"name":[3],"type":["chr"],"align":["left"]},{"label":["source"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"mukey_short","2":"<chr [2]>","3":"ID_short","4":"original"},{"1":"anntavg_norm","2":"<chr [2]>","3":"predictor","4":"original"},{"1":"annprcp_norm","2":"<chr [2]>","3":"predictor","4":"original"},{"1":"x","2":"<chr [2]>","3":"lat_lon","4":"original"},{"1":"y","2":"<chr [2]>","3":"lat_lon","4":"original"},{"1":"mukey","2":"<chr [2]>","3":"ID_long","4":"original"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># retain argument here tells prep to keep </span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the pre-processed training data </span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># note this can make the final recipe size large, </span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># so this is not the recipe object I probably want to use</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co"># in my list col below</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>check_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(rec_spec, <span class="at">retain=</span><span class="cn">TRUE</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co"># using NULL here for new_data b/c I want the </span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co"># pre-processed training data </span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>check_prepped_df <span class="ot">&lt;-</span> <span class="fu">bake</span>(check_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(check_prepped_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mukey_short"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["anntavg_norm"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["annprcp_norm"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["x"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["mukey"],"name":[6],"type":["int"],"align":["right"]}],"data":[{"1":"1","2":"-1.827490","3":"-1.277081","4":"-95.93896","5":"47.60462","6":"352159"},{"1":"3","2":"-1.860597","3":"-1.261877","4":"-95.81576","5":"47.62088","6":"352162"},{"1":"4","2":"-1.845707","3":"-1.271090","4":"-95.89229","5":"47.60323","6":"352165"},{"1":"5","2":"-1.829106","3":"-1.245281","4":"-95.87288","5":"47.57107","6":"352166"},{"1":"6","2":"-1.826411","3":"-1.256533","4":"-95.90152","5":"47.58172","6":"352171"},{"1":"7","2":"-1.887431","3":"-1.282046","4":"-95.78449","5":"47.65950","6":"352174"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save the pre-processed data in case I want to make some plots of </span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the distribution of the normalized (centered/scaled) variables</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(check_prepped_df, <span class="st">"./data/data_preprocessed_only_climate_20240310.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> check_prepped_df) <span class="sc">+</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> annprcp_norm)) <span class="sc">+</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Distribution of *centered &amp; scaled* precipitation (mm) values"</span>) <span class="sc">+</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Annual precipitation normal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> check_prepped_df) <span class="sc">+</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> anntavg_norm)) <span class="sc">+</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Distribution of *centered &amp; scaled* temperature (degree Celsius) values"</span>) <span class="sc">+</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Annual temperature normal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="set-model-options" class="level2" data-number="17.4">
<h2 data-number="17.4" class="anchored" data-anchor-id="set-model-options"><span class="header-section-number">17.4</span> Set model options</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># writing a custom function here so I can be explicit </span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># about the options I'm choosing, and also use within the </span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># list-col framework I set up with map() below. </span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>km_spec <span class="ot">&lt;-</span> <span class="cf">function</span>(nclust){</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  tidyclust<span class="sc">::</span><span class="fu">k_means</span>(<span class="at">num_clusters =</span> nclust) <span class="sc">%&gt;%</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    parsnip<span class="sc">::</span><span class="fu">set_engine</span>(<span class="at">engine =</span> <span class="st">"stats"</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">nstart =</span> <span class="dv">10</span>, <span class="co"># 1 is default, &gt;1 recommended</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">algorithm =</span> <span class="st">"Hartigan-Wong"</span>, <span class="co"># H-W is default</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">iter.max =</span> <span class="dv">20</span>) <span class="co"># default is 10, wasn't always enough</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-up-data-structure" class="level2" data-number="17.5">
<h2 data-number="17.5" class="anchored" data-anchor-id="set-up-data-structure"><span class="header-section-number">17.5</span> Set up data structure</h2>
<p>Here I set up a dataframe that will catch my modeling results in list columns of the different model objects and return values. The first column I define specifies the range of different cluster sizes (k) that we will try.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>try_clusts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>km_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">n_clust =</span> try_clusts)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>km_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]}],"data":[{"1":"2"},{"1":"3"},{"1":"4"},{"1":"5"},{"1":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="specify-model-for-each-value-of-k" class="level2" data-number="17.6">
<h2 data-number="17.6" class="anchored" data-anchor-id="specify-model-for-each-value-of-k"><span class="header-section-number">17.6</span> Specify model (for each value of k)</h2>
<p>For each unique value of k (2-6), this returns a model specification object (in the <code>kmeans_spec</code> column) based on the custom function I wrote above. The model specification has all the options set about how we want the algorithm to run (methods, number of starts, etc.). We need a different one for each value of k.</p>
<p>The <code>kmeans_wflow</code> column here holds our workflow objects. These objects combine our model specification (from <code>kmeans_spec</code>) with the data recipe (preprocessor) we made above (<code>rec_spec</code>, is same for all models).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for each unique value of clusters (2:20), returns a model</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># specification (kmeans_spec) and a workflow (kmeans_wflow) </span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co"># note that the workflow </span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>km_df <span class="ot">&lt;-</span> km_df <span class="sc">%&gt;%</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">kmeans_spec =</span> <span class="fu">map</span>(n_clust, <span class="sc">~</span> <span class="fu">km_spec</span>(<span class="at">nclust =</span> .x)),</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">kmeans_wflow =</span> <span class="fu">map</span>(kmeans_spec,</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span> <span class="fu">workflow</span>(</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">preprocessor =</span> rec_spec, <span class="at">spec =</span> .x</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>                       ))</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="co"># our current data structure</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(km_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]},{"label":["kmeans_spec"],"name":[2],"type":["list"],"align":["right"]},{"label":["kmeans_wflow"],"name":[3],"type":["list"],"align":["right"]}],"data":[{"1":"2","2":"<S3: k_means>","3":"<S3: workflow>","_rn_":"1"},{"1":"3","2":"<S3: k_means>","3":"<S3: workflow>","_rn_":"2"},{"1":"4","2":"<S3: k_means>","3":"<S3: workflow>","_rn_":"3"},{"1":"5","2":"<S3: k_means>","3":"<S3: workflow>","_rn_":"4"},{"1":"6","2":"<S3: k_means>","3":"<S3: workflow>","_rn_":"5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take a look at an example workflow</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>km_df<span class="sc">$</span>kmeans_wflow[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: k_means()

── Preprocessor ────────────────────────────────────────────────────────────────
1 Recipe Step

• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────
K Means Cluster Specification (partition)

Main Arguments:
  num_clusters = nclust

Engine-Specific Arguments:
  nstart = 10
  algorithm = Hartigan-Wong
  iter.max = 20

Computational engine: stats </code></pre>
</div>
</div>
</section>
<section id="fit-the-models" class="level2" data-number="17.7">
<h2 data-number="17.7" class="anchored" data-anchor-id="fit-the-models"><span class="header-section-number">17.7</span> Fit the models</h2>
<p>All the steps above were related to specifying different aspects of this model. Now we can actually fit the models.</p>
<p>Some troubleshooting here:</p>
<ul>
<li>Started by specifying <code>tidyclust::fit()</code> but something weird was happening where my <code>step_normalize()</code> wasn’t included in the pre-processor recipe when I looked at the fitted model object.</li>
<li>If I specify <code>parsnip::fit()</code> , then <code>step_normalize()</code> is included and the values of the cluster centroids are in the expected ranges (centered, scaled).</li>
<li>I also tried this without explicitly specifying the package (so just <code>fit()</code> ) and it worked as expected.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a quiet version of fit(), so we can capture results </span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and any warning messages from the models </span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># see troubleshooting notes below</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>quiet_fit <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">quietly</span>(<span class="at">.f =</span> parsnip<span class="sc">::</span>fit)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>) <span class="co"># for reproducibility </span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>km_fit_df <span class="ot">&lt;-</span> km_df <span class="sc">%&gt;%</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">km_result =</span> <span class="fu">map</span>(<span class="at">.x =</span> kmeans_wflow,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">.f =</span> quiet_fit,</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>       <span class="co"># data comes after .f b/c not vectorized over            </span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> d_incl),</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">km_fit =</span> <span class="fu">map</span>(km_result, <span class="sc">~</span><span class="fu">pluck</span>(.x, <span class="st">'result'</span>)),</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">warn =</span> <span class="fu">map</span>(km_fit, <span class="sc">~</span><span class="fu">pluck</span>(.x, <span class="st">'warnings'</span>)),</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">msg =</span> <span class="fu">map</span>(km_fit, <span class="sc">~</span><span class="fu">pluck</span>(.x, <span class="st">'messages'</span>)),</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">n_iter =</span> <span class="fu">map_dbl</span>(km_fit, </span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">~</span><span class="fu">pluck</span>(.x, <span class="st">'fit'</span>, <span class="st">'fit'</span>, <span class="st">'fit'</span>, <span class="st">'iter'</span> ))) </span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="co"># check out current data structure</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(km_fit_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]},{"label":["kmeans_spec"],"name":[2],"type":["list"],"align":["right"]},{"label":["kmeans_wflow"],"name":[3],"type":["list"],"align":["right"]},{"label":["km_result"],"name":[4],"type":["list"],"align":["right"]},{"label":["km_fit"],"name":[5],"type":["list"],"align":["right"]},{"label":["warn"],"name":[6],"type":["list"],"align":["right"]},{"label":["msg"],"name":[7],"type":["list"],"align":["right"]},{"label":["n_iter"],"name":[8],"type":["dbl"],"align":["right"]}],"data":[{"1":"2","2":"<S3: k_means>","3":"<S3: workflow>","4":"<named list [4]>","5":"<S3: workflow>","6":"<NULL>","7":"<NULL>","8":"1","_rn_":"1"},{"1":"3","2":"<S3: k_means>","3":"<S3: workflow>","4":"<named list [4]>","5":"<S3: workflow>","6":"<NULL>","7":"<NULL>","8":"2","_rn_":"2"},{"1":"4","2":"<S3: k_means>","3":"<S3: workflow>","4":"<named list [4]>","5":"<S3: workflow>","6":"<NULL>","7":"<NULL>","8":"2","_rn_":"3"},{"1":"5","2":"<S3: k_means>","3":"<S3: workflow>","4":"<named list [4]>","5":"<S3: workflow>","6":"<NULL>","7":"<NULL>","8":"3","_rn_":"4"},{"1":"6","2":"<S3: k_means>","3":"<S3: workflow>","4":"<named list [4]>","5":"<S3: workflow>","6":"<NULL>","7":"<NULL>","8":"3","_rn_":"5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># don't need anymore, cleaning up</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(km_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="view-messages-warnings" class="level3" data-number="17.7.1">
<h3 data-number="17.7.1" class="anchored" data-anchor-id="view-messages-warnings"><span class="header-section-number">17.7.1</span> View messages &amp; warnings</h3>
<p>We can look at any warnings or messages from the modeling process:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>km_fit_df <span class="sc">%&gt;%</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, warn, msg, n_iter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]},{"label":["warn"],"name":[2],"type":["list"],"align":["right"]},{"label":["msg"],"name":[3],"type":["list"],"align":["right"]},{"label":["n_iter"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"2","2":"<NULL>","3":"<NULL>","4":"1"},{"1":"3","2":"<NULL>","3":"<NULL>","4":"2"},{"1":"4","2":"<NULL>","3":"<NULL>","4":"2"},{"1":"5","2":"<NULL>","3":"<NULL>","4":"3"},{"1":"6","2":"<NULL>","3":"<NULL>","4":"3"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
</section>
<section id="model-metrics" class="level2" data-number="17.8">
<h2 data-number="17.8" class="anchored" data-anchor-id="model-metrics"><span class="header-section-number">17.8</span> Model metrics</h2>
<p>See also section 7.5 in the Chapter by Tan et al.&nbsp;for more about cluster evaluation.</p>
<section id="extract-metrics" class="level3" data-number="17.8.1">
<h3 data-number="17.8.1" class="anchored" data-anchor-id="extract-metrics"><span class="header-section-number">17.8.1</span> Extract metrics</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="ot">&lt;-</span> km_fit_df <span class="sc">%&gt;%</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tot_sse = total sum of squared error</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_sse =</span> <span class="fu">map_dbl</span>(km_fit, <span class="sc">~</span> <span class="fu">sse_total_vec</span>(.x)),</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tot_wss = sum of within-cluster sse</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_wss =</span> <span class="fu">map_dbl</span>(km_fit, <span class="sc">~</span><span class="fu">sse_within_total_vec</span>(.x)),</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sse ratio = wss / total sse, </span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sse_ratio =</span> <span class="fu">map_dbl</span>(km_fit, <span class="sc">~</span><span class="fu">sse_ratio_vec</span>(.x))</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(km_fit_df)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>metrics_simple <span class="ot">&lt;-</span> metrics_df <span class="sc">%&gt;%</span> </span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, tot_sse, tot_wss, sse_ratio)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>metrics_simple</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]},{"label":["tot_sse"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["tot_wss"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["sse_ratio"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"2","2":"13742","3":"4684.4191","4":"0.34088336"},{"1":"3","2":"13742","3":"2353.5427","4":"0.17126639"},{"1":"4","2":"13742","3":"1542.9328","4":"0.11227862"},{"1":"5","2":"13742","3":"1111.3279","4":"0.08087090"},{"1":"6","2":"13742","3":"892.3804","4":"0.06493818"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="plot-total-wss" class="level3" data-number="17.8.2">
<h3 data-number="17.8.2" class="anchored" data-anchor-id="plot-total-wss"><span class="header-section-number">17.8.2</span> Plot Total WSS</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>metrics_simple <span class="sc">%&gt;%</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_clust, <span class="at">y =</span> tot_wss)) <span class="sc">+</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"k (number clusters)"</span>) <span class="sc">+</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"sum of within-cluster sse"</span>) <span class="sc">+</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Compare values of k: looking for elbow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="average-silhouette" class="level3" data-number="17.8.3">
<h3 data-number="17.8.3" class="anchored" data-anchor-id="average-silhouette"><span class="header-section-number">17.8.3</span> Average Silhouette</h3>
<p>From the <code>{tidyclust}</code> documentation:</p>
<blockquote class="blockquote">
<p>Another common measure of cluster structure is called the <strong>silhouette</strong>. The silhouette of a single observation is proportional to the average distance from that observation to within-cluster observations minus the average distance to outside-cluster observations; normalized by the greater of these two average.<br>
</p>
<p>In principle, a large silhouette (close to 1) suggests that an observation is more similar to those within its cluster than those outside its cluster.</p>
</blockquote>
<p>See also pg. 581 in Tan2018 Chap 7 Cluster Analysis: Basic Concepts and Algorithms</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>prepped_rec <span class="ot">&lt;-</span> <span class="fu">prep</span>(rec_spec, <span class="at">retain=</span><span class="cn">TRUE</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># using NULL here for new_data b/c I want the </span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pre-processed training data </span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>baked_df <span class="ot">&lt;-</span> <span class="fu">bake</span>(prepped_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>mukey) </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>dists <span class="ot">&lt;-</span> baked_df <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span> <span class="fu">dist</span>(<span class="at">method =</span> <span class="st">"euclidean"</span>)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>silh_df <span class="ot">&lt;-</span> metrics_df <span class="sc">%&gt;%</span> </span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_sil =</span> <span class="fu">map_dbl</span>(km_fit, </span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>                       tidyclust<span class="sc">::</span>silhouette_avg_vec,</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">dists =</span> dists),</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">indiv_sil =</span> <span class="fu">map</span>(km_fit, </span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>                         tidyclust<span class="sc">::</span>silhouette,</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">dists =</span> dists))</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>indiv_sil_df <span class="ot">&lt;-</span> silh_df <span class="sc">%&gt;%</span> <span class="fu">select</span>(n_clust, indiv_sil) <span class="sc">%&gt;%</span> </span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(indiv_sil) <span class="sc">%&gt;%</span> </span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(cluster, neighbor),</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">.fns =</span> as.character))</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(indiv_sil_df, <span class="st">"data/kmeans_points_silhouettes_climate_only.csv"</span>)</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(metrics_df)  </span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(dists)</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(prepped_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Higher silhouette is better (means observations are closer to their centroids than to other observations).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>silh_df <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_clust, <span class="at">y =</span> avg_sil)) <span class="sc">+</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Overall Average Silhouette"</span>) <span class="sc">+</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Higher is better, possible values [-1,1]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>clust_sil_avgs <span class="ot">&lt;-</span> indiv_sil_df <span class="sc">%&gt;%</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster,</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>           n_clust) <span class="sc">%&gt;%</span> </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_sil =</span> <span class="fu">mean</span>(sil_width),</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd_sil =</span> <span class="fu">sd</span>(sil_width), </span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>clust_sil_avgs <span class="sc">%&gt;%</span> </span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">str_replace</span>(cluster, <span class="st">"Cluster_"</span>, <span class="st">"c0"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> cluster, <span class="at">x =</span> mean_sil)) <span class="sc">+</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(n_clust), <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span> </span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Average silhouette width per cluster for k=2-6"</span>) <span class="sc">+</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="calinski-harabasz-index" class="level3" data-number="17.8.4">
<h3 data-number="17.8.4" class="anchored" data-anchor-id="calinski-harabasz-index"><span class="header-section-number">17.8.4</span> Calinski-Harabasz index</h3>
<p><strong>Not used: <code>{NbClust}</code></strong> <strong>, using <code>{fpc}</code> instead.</strong></p>
<p>Using the implementation of the Calinski-Harabasz index from the <code>{fpc}</code> package. This is preferred to my original approach, where I used the <code>NbClust</code> function from <code>{NbClust}</code> package because I can give this function my clustering generated above (NbClust does its own run of kmeans but I can’t customize it to keep it consistent with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calinhara wants an observations/variables matrix</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as first argument (as opposed to a distance matrix)</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>obsvar_mx <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(baked_df)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="co"># function to extract and modify tidyclust clusters</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="co"># into a integer vector, which I will pass to calinhara()</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>create_clust_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(fit_obj){</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_cluster_assignment</span>(fit_obj) <span class="sc">%&gt;%</span> </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(.cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace</span>(., <span class="st">"Cluster_"</span>, <span class="st">""</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.integer</span>()</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="co"># apply function to extract clusterings as integer vectors</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a><span class="co"># map to get a c-h index value for every value of k (2-20)</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>ch_metrics <span class="ot">&lt;-</span> silh_df <span class="sc">%&gt;%</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, km_fit) <span class="sc">%&gt;%</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">clustering_vec =</span> <span class="fu">map</span>(km_fit, create_clust_vec),</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">ch_index =</span> <span class="fu">map_dbl</span>(clustering_vec,</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span> fpc<span class="sc">::</span><span class="fu">calinhara</span>(<span class="at">x =</span> obsvar_mx,</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">clustering =</span> .x)</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>ch_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_clust, <span class="at">y =</span> ch_index)) <span class="sc">+</span> </span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Calinski-Harabasz index"</span>) <span class="sc">+</span> </span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Calinski-Harabasz"</span>) <span class="sc">+</span></span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Higher is better"</span>) <span class="sc">+</span></span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="wss-and-silhouette-metrics-on-one-plot" class="level3" data-number="17.8.5">
<h3 data-number="17.8.5" class="anchored" data-anchor-id="wss-and-silhouette-metrics-on-one-plot"><span class="header-section-number">17.8.5</span> WSS and Silhouette metrics on one plot</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="288"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="save-model-fits" class="level2" data-number="17.9">
<h2 data-number="17.9" class="anchored" data-anchor-id="save-model-fits"><span class="header-section-number">17.9</span> Save model fits</h2>
<p>Will save these as Rdata so I can call them up and investigate them further as needed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>mods <span class="ot">&lt;-</span> silh_df <span class="sc">%&gt;%</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, km_fit)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(mods, <span class="at">file =</span> <span class="st">"data/fitted_kmeans_mods_climate_only.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="save-cluster-assignments" class="level2" data-number="17.10">
<h2 data-number="17.10" class="anchored" data-anchor-id="save-cluster-assignments"><span class="header-section-number">17.10</span> Save cluster assignments</h2>
<p>For each version of the model (each value of k, different numbers of clusters), a MUKEY is assigned to a specific cluster. Here, I’m pulling that data, shaping it into one dataframe (one row per MUKEY, cluster assignments in separate columns). I’m also adding back in the soil property data so we can use this in the next step when evaluating different cluster sizes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>clust_assign_df <span class="ot">&lt;-</span> mods <span class="sc">%&gt;%</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">clust_assign =</span> <span class="fu">map</span>(km_fit, <span class="sc">~</span><span class="fu">augment</span>(.x, <span class="at">new_data =</span> d_incl)),</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">mukey_clust =</span> <span class="fu">map</span>(clust_assign, <span class="sc">~</span><span class="fu">select</span>(.x, mukey, .pred_cluster)))</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>assign_mukey_df <span class="ot">&lt;-</span> clust_assign_df <span class="sc">%&gt;%</span> </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, mukey_clust) <span class="sc">%&gt;%</span> </span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(mukey_clust) <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> n_clust, <span class="at">values_from =</span> .pred_cluster, <span class="at">names_prefix =</span> <span class="st">"k_"</span>)</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>clust_props <span class="ot">&lt;-</span> <span class="fu">full_join</span>(d_incl, assign_mukey_df, <span class="at">by =</span> <span class="st">"mukey"</span>)</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(clust_props, <span class="st">"data/mukey_cluster_assignments_and_props_climate_only.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="map-clusters" class="level2" data-number="17.11">
<h2 data-number="17.11" class="anchored" data-anchor-id="map-clusters"><span class="header-section-number">17.11</span> Map clusters</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>clust_long <span class="ot">&lt;-</span> clust_props <span class="sc">%&gt;%</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>mukey) <span class="sc">%&gt;%</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"k_"</span>),</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"model_ver"</span>,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"cluster_assignment"</span>)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>climsf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(clust_long, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>))</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>climsf <span class="ot">&lt;-</span> <span class="fu">st_set_crs</span>(climsf, <span class="dv">4326</span>) </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> climsf) <span class="sc">+</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> cluster_assignment)) <span class="sc">+</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a> <span class="co"># scale_color_viridis_d() + </span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(model_ver)) <span class="sc">+</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Map unit centroids color coded by climate cluster"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>clust_long <span class="sc">%&gt;%</span> </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(model_ver, cluster_assignment) <span class="sc">%&gt;%</span> </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_temp =</span> <span class="fu">min</span>(anntavg_norm),</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_temp =</span> <span class="fu">max</span>(anntavg_norm),</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_temp =</span> <span class="fu">mean</span>(anntavg_norm),</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_prcp =</span> <span class="fu">min</span>(annprcp_norm),</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_prcp =</span> <span class="fu">max</span>(annprcp_norm),</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean_prcp =</span> <span class="fu">mean</span>(annprcp_norm)) <span class="sc">%&gt;%</span> </span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">contains</span>(<span class="st">"temp"</span>), <span class="at">.fns =</span> <span class="sc">~</span><span class="fu">round</span>(.x, <span class="at">digits =</span> <span class="dv">1</span>)),</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">contains</span>(<span class="st">'prcp'</span>), <span class="at">.fns =</span> <span class="sc">~</span><span class="fu">round</span>(.x, <span class="at">digits =</span> <span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"MAT normal (Celsius)"</span>,</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"temp"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_spanner</span>(<span class="at">label =</span> <span class="st">"MAP normal (mm)"</span>,</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">columns =</span> <span class="fu">contains</span>(<span class="st">"prcp"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(<span class="at">min_temp =</span> <span class="st">"Min."</span>,</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">max_temp =</span> <span class="st">"Max."</span>,</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean_temp =</span> <span class="st">"Mean"</span>,</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">min_prcp =</span> <span class="st">"Min."</span>,</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">max_prcp =</span> <span class="st">"Max."</span>, </span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean_prcp =</span> <span class="st">"Mean"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'model_ver'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output-display">
<div>
<div id="jzosqmosbs" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#jzosqmosbs table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#jzosqmosbs thead, #jzosqmosbs tbody, #jzosqmosbs tfoot, #jzosqmosbs tr, #jzosqmosbs td, #jzosqmosbs th {
  border-style: none;
}

#jzosqmosbs p {
  margin: 0;
  padding: 0;
}

#jzosqmosbs .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#jzosqmosbs .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#jzosqmosbs .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#jzosqmosbs .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#jzosqmosbs .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jzosqmosbs .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jzosqmosbs .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jzosqmosbs .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#jzosqmosbs .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#jzosqmosbs .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#jzosqmosbs .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#jzosqmosbs .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#jzosqmosbs .gt_spanner_row {
  border-bottom-style: hidden;
}

#jzosqmosbs .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#jzosqmosbs .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#jzosqmosbs .gt_from_md > :first-child {
  margin-top: 0;
}

#jzosqmosbs .gt_from_md > :last-child {
  margin-bottom: 0;
}

#jzosqmosbs .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#jzosqmosbs .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#jzosqmosbs .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#jzosqmosbs .gt_row_group_first td {
  border-top-width: 2px;
}

#jzosqmosbs .gt_row_group_first th {
  border-top-width: 2px;
}

#jzosqmosbs .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jzosqmosbs .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#jzosqmosbs .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#jzosqmosbs .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jzosqmosbs .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jzosqmosbs .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#jzosqmosbs .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#jzosqmosbs .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#jzosqmosbs .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jzosqmosbs .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jzosqmosbs .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jzosqmosbs .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jzosqmosbs .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jzosqmosbs .gt_left {
  text-align: left;
}

#jzosqmosbs .gt_center {
  text-align: center;
}

#jzosqmosbs .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#jzosqmosbs .gt_font_normal {
  font-weight: normal;
}

#jzosqmosbs .gt_font_bold {
  font-weight: bold;
}

#jzosqmosbs .gt_font_italic {
  font-style: italic;
}

#jzosqmosbs .gt_super {
  font-size: 65%;
}

#jzosqmosbs .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#jzosqmosbs .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#jzosqmosbs .gt_indent_1 {
  text-indent: 5px;
}

#jzosqmosbs .gt_indent_2 {
  text-indent: 10px;
}

#jzosqmosbs .gt_indent_3 {
  text-indent: 15px;
}

#jzosqmosbs .gt_indent_4 {
  text-indent: 20px;
}

#jzosqmosbs .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="header gt_col_headings gt_spanner_row">
<th rowspan="2" id="cluster_assignment" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">cluster_assignment</th>
<th rowspan="2" id="n" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">n</th>
<th colspan="3" id="MAT normal (Celsius)" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><span class="gt_column_spanner">MAT normal (Celsius)</span></th>
<th colspan="3" id="MAP normal (mm)" class="gt_center gt_columns_top_border gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><span class="gt_column_spanner">MAP normal (mm)</span></th>
</tr>
<tr class="odd gt_col_headings">
<th id="Min." class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Min.</th>
<th id="Max." class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Max.</th>
<th id="Mean" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Mean</th>
<th id="Min." class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Min.</th>
<th id="Max." class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Max.</th>
<th id="Mean" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Mean</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd gt_group_heading_row">
<td colspan="8" id="k_2" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">k_2</td>
</tr>
<tr class="even gt_row_group_first">
<td class="gt_row gt_center" headers="k_2  cluster_assignment">Cluster_1</td>
<td class="gt_row gt_right" headers="k_2  n">2435</td>
<td class="gt_row gt_right" headers="k_2  min_temp">3.5</td>
<td class="gt_row gt_right" headers="k_2  max_temp">6.8</td>
<td class="gt_row gt_right" headers="k_2  mean_temp">5.0</td>
<td class="gt_row gt_right" headers="k_2  min_prcp">549</td>
<td class="gt_row gt_right" headers="k_2  max_prcp">747</td>
<td class="gt_row gt_right" headers="k_2  mean_prcp">640</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="k_2  cluster_assignment">Cluster_2</td>
<td class="gt_row gt_right" headers="k_2  n">4437</td>
<td class="gt_row gt_right" headers="k_2  min_temp">5.9</td>
<td class="gt_row gt_right" headers="k_2  max_temp">8.4</td>
<td class="gt_row gt_right" headers="k_2  mean_temp">7.0</td>
<td class="gt_row gt_right" headers="k_2  min_prcp">645</td>
<td class="gt_row gt_right" headers="k_2  max_prcp">962</td>
<td class="gt_row gt_right" headers="k_2  mean_prcp">808</td>
</tr>
<tr class="even gt_group_heading_row">
<td colspan="8" id="k_3" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">k_3</td>
</tr>
<tr class="odd gt_row_group_first">
<td class="gt_row gt_center" headers="k_3  cluster_assignment">Cluster_1</td>
<td class="gt_row gt_right" headers="k_3  n">1750</td>
<td class="gt_row gt_right" headers="k_3  min_temp">3.5</td>
<td class="gt_row gt_right" headers="k_3  max_temp">5.8</td>
<td class="gt_row gt_right" headers="k_3  mean_temp">4.6</td>
<td class="gt_row gt_right" headers="k_3  min_prcp">549</td>
<td class="gt_row gt_right" headers="k_3  max_prcp">724</td>
<td class="gt_row gt_right" headers="k_3  mean_prcp">630</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="k_3  cluster_assignment">Cluster_2</td>
<td class="gt_row gt_right" headers="k_3  n">2656</td>
<td class="gt_row gt_right" headers="k_3  min_temp">5.3</td>
<td class="gt_row gt_right" headers="k_3  max_temp">7.4</td>
<td class="gt_row gt_right" headers="k_3  mean_temp">6.6</td>
<td class="gt_row gt_right" headers="k_3  min_prcp">619</td>
<td class="gt_row gt_right" headers="k_3  max_prcp">792</td>
<td class="gt_row gt_right" headers="k_3  mean_prcp">717</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="k_3  cluster_assignment">Cluster_3</td>
<td class="gt_row gt_right" headers="k_3  n">2466</td>
<td class="gt_row gt_right" headers="k_3  min_temp">6.7</td>
<td class="gt_row gt_right" headers="k_3  max_temp">8.4</td>
<td class="gt_row gt_right" headers="k_3  mean_temp">7.3</td>
<td class="gt_row gt_right" headers="k_3  min_prcp">774</td>
<td class="gt_row gt_right" headers="k_3  max_prcp">962</td>
<td class="gt_row gt_right" headers="k_3  mean_prcp">866</td>
</tr>
<tr class="even gt_group_heading_row">
<td colspan="8" id="k_4" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">k_4</td>
</tr>
<tr class="odd gt_row_group_first">
<td class="gt_row gt_center" headers="k_4  cluster_assignment">Cluster_1</td>
<td class="gt_row gt_right" headers="k_4  n">1123</td>
<td class="gt_row gt_right" headers="k_4  min_temp">3.5</td>
<td class="gt_row gt_right" headers="k_4  max_temp">5.2</td>
<td class="gt_row gt_right" headers="k_4  mean_temp">4.3</td>
<td class="gt_row gt_right" headers="k_4  min_prcp">549</td>
<td class="gt_row gt_right" headers="k_4  max_prcp">676</td>
<td class="gt_row gt_right" headers="k_4  mean_prcp">608</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="k_4  cluster_assignment">Cluster_2</td>
<td class="gt_row gt_right" headers="k_4  n">1340</td>
<td class="gt_row gt_right" headers="k_4  min_temp">4.8</td>
<td class="gt_row gt_right" headers="k_4  max_temp">6.6</td>
<td class="gt_row gt_right" headers="k_4  mean_temp">5.7</td>
<td class="gt_row gt_right" headers="k_4  min_prcp">586</td>
<td class="gt_row gt_right" headers="k_4  max_prcp">747</td>
<td class="gt_row gt_right" headers="k_4  mean_prcp">671</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="k_4  cluster_assignment">Cluster_3</td>
<td class="gt_row gt_right" headers="k_4  n">2261</td>
<td class="gt_row gt_right" headers="k_4  min_temp">6.0</td>
<td class="gt_row gt_right" headers="k_4  max_temp">7.6</td>
<td class="gt_row gt_right" headers="k_4  mean_temp">6.8</td>
<td class="gt_row gt_right" headers="k_4  min_prcp">641</td>
<td class="gt_row gt_right" headers="k_4  max_prcp">806</td>
<td class="gt_row gt_right" headers="k_4  mean_prcp">742</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="k_4  cluster_assignment">Cluster_4</td>
<td class="gt_row gt_right" headers="k_4  n">2148</td>
<td class="gt_row gt_right" headers="k_4  min_temp">6.7</td>
<td class="gt_row gt_right" headers="k_4  max_temp">8.4</td>
<td class="gt_row gt_right" headers="k_4  mean_temp">7.3</td>
<td class="gt_row gt_right" headers="k_4  min_prcp">798</td>
<td class="gt_row gt_right" headers="k_4  max_prcp">962</td>
<td class="gt_row gt_right" headers="k_4  mean_prcp">877</td>
</tr>
<tr class="odd gt_group_heading_row">
<td colspan="8" id="k_5" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">k_5</td>
</tr>
<tr class="even gt_row_group_first">
<td class="gt_row gt_center" headers="k_5  cluster_assignment">Cluster_1</td>
<td class="gt_row gt_right" headers="k_5  n">1101</td>
<td class="gt_row gt_right" headers="k_5  min_temp">3.5</td>
<td class="gt_row gt_right" headers="k_5  max_temp">5.2</td>
<td class="gt_row gt_right" headers="k_5  mean_temp">4.3</td>
<td class="gt_row gt_right" headers="k_5  min_prcp">549</td>
<td class="gt_row gt_right" headers="k_5  max_prcp">673</td>
<td class="gt_row gt_right" headers="k_5  mean_prcp">607</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="k_5  cluster_assignment">Cluster_2</td>
<td class="gt_row gt_right" headers="k_5  n">1307</td>
<td class="gt_row gt_right" headers="k_5  min_temp">4.8</td>
<td class="gt_row gt_right" headers="k_5  max_temp">6.5</td>
<td class="gt_row gt_right" headers="k_5  mean_temp">5.6</td>
<td class="gt_row gt_right" headers="k_5  min_prcp">586</td>
<td class="gt_row gt_right" headers="k_5  max_prcp">747</td>
<td class="gt_row gt_right" headers="k_5  mean_prcp">669</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="k_5  cluster_assignment">Cluster_3</td>
<td class="gt_row gt_right" headers="k_5  n">1304</td>
<td class="gt_row gt_right" headers="k_5  min_temp">6.9</td>
<td class="gt_row gt_right" headers="k_5  max_temp">7.8</td>
<td class="gt_row gt_right" headers="k_5  mean_temp">7.4</td>
<td class="gt_row gt_right" headers="k_5  min_prcp">761</td>
<td class="gt_row gt_right" headers="k_5  max_prcp">866</td>
<td class="gt_row gt_right" headers="k_5  mean_prcp">817</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="k_5  cluster_assignment">Cluster_4</td>
<td class="gt_row gt_right" headers="k_5  n">1266</td>
<td class="gt_row gt_right" headers="k_5  min_temp">6.7</td>
<td class="gt_row gt_right" headers="k_5  max_temp">8.4</td>
<td class="gt_row gt_right" headers="k_5  mean_temp">7.1</td>
<td class="gt_row gt_right" headers="k_5  min_prcp">863</td>
<td class="gt_row gt_right" headers="k_5  max_prcp">962</td>
<td class="gt_row gt_right" headers="k_5  mean_prcp">909</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="k_5  cluster_assignment">Cluster_5</td>
<td class="gt_row gt_right" headers="k_5  n">1894</td>
<td class="gt_row gt_right" headers="k_5  min_temp">5.9</td>
<td class="gt_row gt_right" headers="k_5  max_temp">7.4</td>
<td class="gt_row gt_right" headers="k_5  mean_temp">6.7</td>
<td class="gt_row gt_right" headers="k_5  min_prcp">641</td>
<td class="gt_row gt_right" headers="k_5  max_prcp">786</td>
<td class="gt_row gt_right" headers="k_5  mean_prcp">731</td>
</tr>
<tr class="odd gt_group_heading_row">
<td colspan="8" id="k_6" class="gt_group_heading" data-quarto-table-cell-role="th" scope="colgroup">k_6</td>
</tr>
<tr class="even gt_row_group_first">
<td class="gt_row gt_center" headers="k_6  cluster_assignment">Cluster_1</td>
<td class="gt_row gt_right" headers="k_6  n">867</td>
<td class="gt_row gt_right" headers="k_6  min_temp">3.5</td>
<td class="gt_row gt_right" headers="k_6  max_temp">5.0</td>
<td class="gt_row gt_right" headers="k_6  mean_temp">4.1</td>
<td class="gt_row gt_right" headers="k_6  min_prcp">549</td>
<td class="gt_row gt_right" headers="k_6  max_prcp">663</td>
<td class="gt_row gt_right" headers="k_6  mean_prcp">597</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="k_6  cluster_assignment">Cluster_2</td>
<td class="gt_row gt_right" headers="k_6  n">919</td>
<td class="gt_row gt_right" headers="k_6  min_temp">4.4</td>
<td class="gt_row gt_right" headers="k_6  max_temp">5.8</td>
<td class="gt_row gt_right" headers="k_6  mean_temp">5.1</td>
<td class="gt_row gt_right" headers="k_6  min_prcp">580</td>
<td class="gt_row gt_right" headers="k_6  max_prcp">738</td>
<td class="gt_row gt_right" headers="k_6  mean_prcp">672</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="k_6  cluster_assignment">Cluster_3</td>
<td class="gt_row gt_right" headers="k_6  n">711</td>
<td class="gt_row gt_right" headers="k_6  min_temp">5.6</td>
<td class="gt_row gt_right" headers="k_6  max_temp">6.9</td>
<td class="gt_row gt_right" headers="k_6  mean_temp">6.1</td>
<td class="gt_row gt_right" headers="k_6  min_prcp">616</td>
<td class="gt_row gt_right" headers="k_6  max_prcp">730</td>
<td class="gt_row gt_right" headers="k_6  mean_prcp">653</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="k_6  cluster_assignment">Cluster_4</td>
<td class="gt_row gt_right" headers="k_6  n">1290</td>
<td class="gt_row gt_right" headers="k_6  min_temp">6.9</td>
<td class="gt_row gt_right" headers="k_6  max_temp">7.8</td>
<td class="gt_row gt_right" headers="k_6  mean_temp">7.4</td>
<td class="gt_row gt_right" headers="k_6  min_prcp">761</td>
<td class="gt_row gt_right" headers="k_6  max_prcp">866</td>
<td class="gt_row gt_right" headers="k_6  mean_prcp">818</td>
</tr>
<tr class="even">
<td class="gt_row gt_center" headers="k_6  cluster_assignment">Cluster_5</td>
<td class="gt_row gt_right" headers="k_6  n">1266</td>
<td class="gt_row gt_right" headers="k_6  min_temp">6.7</td>
<td class="gt_row gt_right" headers="k_6  max_temp">8.4</td>
<td class="gt_row gt_right" headers="k_6  mean_temp">7.1</td>
<td class="gt_row gt_right" headers="k_6  min_prcp">863</td>
<td class="gt_row gt_right" headers="k_6  max_prcp">962</td>
<td class="gt_row gt_right" headers="k_6  mean_prcp">909</td>
</tr>
<tr class="odd">
<td class="gt_row gt_center" headers="k_6  cluster_assignment">Cluster_6</td>
<td class="gt_row gt_right" headers="k_6  n">1819</td>
<td class="gt_row gt_right" headers="k_6  min_temp">5.7</td>
<td class="gt_row gt_right" headers="k_6  max_temp">7.4</td>
<td class="gt_row gt_right" headers="k_6  mean_temp">6.7</td>
<td class="gt_row gt_right" headers="k_6  min_prcp">664</td>
<td class="gt_row gt_right" headers="k_6  max_prcp">786</td>
<td class="gt_row gt_right" headers="k_6  mean_prcp">735</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>clust_long <span class="sc">%&gt;%</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster_assignment =</span> <span class="fu">str_replace</span>(cluster_assignment, <span class="st">"Cluster_"</span>, <span class="st">"C"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cluster_assignment, <span class="at">y =</span> anntavg_norm)) <span class="sc">+</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(model_ver), <span class="at">axes =</span> <span class="st">"all_x"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Annual temperature normals by model version &amp; cluster"</span>) <span class="sc">+</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Annual temp. normal (degrees C)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>clust_long <span class="sc">%&gt;%</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster_assignment =</span> <span class="fu">str_replace</span>(cluster_assignment, <span class="st">"Cluster_"</span>, <span class="st">"C"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cluster_assignment, <span class="at">y =</span> annprcp_norm)) <span class="sc">+</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(model_ver), <span class="at">axes =</span> <span class="st">"all_x"</span>, <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Annual precipitation normals by model version &amp; cluster"</span>) <span class="sc">+</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Annual precip normal (mm)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="35-climate-clusters_files/figure-html/unnamed-chunk-20-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./32-sample-climate-vars.html" class="pagination-link" aria-label="Sample climate data at map-unit centroids">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Sample climate data at map-unit centroids</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./19-sample-points.html" class="pagination-link" aria-label="Sample validation points">
        <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Sample validation points</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>