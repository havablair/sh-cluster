<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Minnesota Topsoil Classification for Soil Health Assessment - 11&nbsp; Do PCA before k-means</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./23-pca-kmeans-finalists.html" rel="next">
<link href="./11-implement-kmeans.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>



</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./22-pca-kmeans.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Do PCA before k-means</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Minnesota Topsoil Classification for Soil Health Assessment</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data_sources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data Sources</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-mus_comp_in_aoi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Explore Map Units &amp; Components in AOI</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-subset-component-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Identify Target Components</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-horiz-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Horizon Data Averages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-soil-prop-eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Soil Property Exploratory Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-map-unit-agg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Map unit aggregation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-var-transformations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Variable Transformations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-plot-ec-lep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">MAP EC and LEP with <code>{terra}</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-additional-data-prep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Additional Data Preparation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-implement-kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Implement k-means</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22-pca-kmeans.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Do PCA before k-means</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23-pca-kmeans-finalists.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Clustering Finalists</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24-compare-kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Comparing k-means scenarios</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26-notes-pca6-8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Comparing PCA 6 &amp; PCA 8 Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31-demo-weighted-centroids.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Find map unit weighted centroids</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32-sample-climate-vars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Sample climate data at map-unit centroids</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35-climate-clusters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Cluster map units based on climate</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19-sample-points.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Sample validation points</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./29-welch-pairwise.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Welch ANOVA for PCA cluster pairwise comparisons</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36-update-welch-compare-variation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Welch ANOVA - compare variation explained</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">11.1</span> Overview</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">11.2</span> Implementation</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">11.3</span> Setup</a></li>
  <li><a href="#pre-process-data-build-recipe" id="toc-pre-process-data-build-recipe" class="nav-link" data-scroll-target="#pre-process-data-build-recipe"><span class="header-section-number">11.4</span> Pre-process data (build recipe)</a></li>
  <li><a href="#functions-to-run-pca-visualize-results" id="toc-functions-to-run-pca-visualize-results" class="nav-link" data-scroll-target="#functions-to-run-pca-visualize-results"><span class="header-section-number">11.5</span> Functions to run PCA, visualize results</a></li>
  <li><a href="#principal-components-analysis-pca" id="toc-principal-components-analysis-pca" class="nav-link" data-scroll-target="#principal-components-analysis-pca"><span class="header-section-number">11.6</span> Principal Components Analysis (PCA)</a>
  <ul class="collapse">
  <li><a href="#visualize-pca-results" id="toc-visualize-pca-results" class="nav-link" data-scroll-target="#visualize-pca-results"><span class="header-section-number">11.6.1</span> Visualize PCA results</a></li>
  <li><a href="#extract-loadings" id="toc-extract-loadings" class="nav-link" data-scroll-target="#extract-loadings"><span class="header-section-number">11.6.2</span> Extract loadings</a></li>
  <li><a href="#extract-variance" id="toc-extract-variance" class="nav-link" data-scroll-target="#extract-variance"><span class="header-section-number">11.6.3</span> Extract variance</a></li>
  <li><a href="#select-pcs-to-keep" id="toc-select-pcs-to-keep" class="nav-link" data-scroll-target="#select-pcs-to-keep"><span class="header-section-number">11.6.4</span> Select PCs to keep</a></li>
  </ul></li>
  <li><a href="#sec-mod-opt" id="toc-sec-mod-opt" class="nav-link" data-scroll-target="#sec-mod-opt"><span class="header-section-number">11.7</span> Set model options</a></li>
  <li><a href="#set-up-data-structure-and-kmeans-recipe" id="toc-set-up-data-structure-and-kmeans-recipe" class="nav-link" data-scroll-target="#set-up-data-structure-and-kmeans-recipe"><span class="header-section-number">11.8</span> Set up data structure and kmeans recipe</a></li>
  <li><a href="#specify-model-for-each-value-of-k" id="toc-specify-model-for-each-value-of-k" class="nav-link" data-scroll-target="#specify-model-for-each-value-of-k"><span class="header-section-number">11.9</span> Specify model (for each value of k)</a></li>
  <li><a href="#fit-the-models" id="toc-fit-the-models" class="nav-link" data-scroll-target="#fit-the-models"><span class="header-section-number">11.10</span> Fit the models</a>
  <ul class="collapse">
  <li><a href="#view-messages-warnings" id="toc-view-messages-warnings" class="nav-link" data-scroll-target="#view-messages-warnings"><span class="header-section-number">11.10.1</span> View messages &amp; warnings</a></li>
  <li><a href="#look-at-one-fit-object" id="toc-look-at-one-fit-object" class="nav-link" data-scroll-target="#look-at-one-fit-object"><span class="header-section-number">11.10.2</span> Look at one fit object</a></li>
  </ul></li>
  <li><a href="#sec-mod-metrics" id="toc-sec-mod-metrics" class="nav-link" data-scroll-target="#sec-mod-metrics"><span class="header-section-number">11.11</span> Model metrics</a>
  <ul class="collapse">
  <li><a href="#extract-metrics" id="toc-extract-metrics" class="nav-link" data-scroll-target="#extract-metrics"><span class="header-section-number">11.11.1</span> Extract metrics</a></li>
  <li><a href="#plot-total-wss" id="toc-plot-total-wss" class="nav-link" data-scroll-target="#plot-total-wss"><span class="header-section-number">11.11.2</span> Plot Total WSS</a></li>
  <li><a href="#average-silhouette" id="toc-average-silhouette" class="nav-link" data-scroll-target="#average-silhouette"><span class="header-section-number">11.11.3</span> Average Silhouette</a></li>
  <li><a href="#not-used-gap-statistic" id="toc-not-used-gap-statistic" class="nav-link" data-scroll-target="#not-used-gap-statistic"><span class="header-section-number">11.11.4</span> Not used: Gap statistic</a></li>
  <li><a href="#calinski-harabasz-index" id="toc-calinski-harabasz-index" class="nav-link" data-scroll-target="#calinski-harabasz-index"><span class="header-section-number">11.11.5</span> Calinski-Harabasz index</a></li>
  <li><a href="#hopkins-statistic" id="toc-hopkins-statistic" class="nav-link" data-scroll-target="#hopkins-statistic"><span class="header-section-number">11.11.6</span> Hopkins Statistic</a></li>
  <li><a href="#wss-and-silhouette-metrics-on-one-plot" id="toc-wss-and-silhouette-metrics-on-one-plot" class="nav-link" data-scroll-target="#wss-and-silhouette-metrics-on-one-plot"><span class="header-section-number">11.11.7</span> WSS and Silhouette metrics on one plot</a></li>
  </ul></li>
  <li><a href="#save-model-fits" id="toc-save-model-fits" class="nav-link" data-scroll-target="#save-model-fits"><span class="header-section-number">11.12</span> Save model fits</a></li>
  <li><a href="#save-cluster-assignments" id="toc-save-cluster-assignments" class="nav-link" data-scroll-target="#save-cluster-assignments"><span class="header-section-number">11.13</span> Save cluster assignments</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Do PCA before k-means</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">11.1</span> Overview</h2>
<p>After lots of reading during the drafting phase of methods &amp; results for my original k-means analysis, I found many authors in soil science, climate/atomspheric science, and geochemistry who use principal components analysis (PCA) for data reduction prior to doing k-means. The argument for doing this is that when you have highly correlated variables), including them all basically gives more weight to the correlated variables. If they are highly correlated, they contain most of the same “information”, and by including both variables you are giving that “information” more weight in the calculation of (dis)similarity matrix (Euclidean distances) that we ultimately use for clustering.</p>
<p>My plan is to do PCA, run k-means again, and compare the results with my original k-means analysis. I think this would be a valuable thing to add to my paper, as we can make an argument for whether one method or another might be more generalizable for others who want to use this technique for creating similar conceptual clusters from a regional set of soil data (presumably with a slightly different set of variables given the specific context).</p>
</section>
<section id="implementation" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="implementation"><span class="header-section-number">11.2</span> Implementation</h2>
<p>There is an easy way to do PCA as a pre-processing step in the <code>{tidymodels}</code> framework I’ve been doing using the <code>step_pca()</code> function. Under the hood, this uses <code>stats::prcomp()</code> to do the PCA.</p>
<p>Much of this code will be similar to <a href="11-implement-kmeans.html" class="quarto-xref"><span>Chapter 10</span></a>, but with some additional exploratory plots as I think about how to incorporate this information in my manuscript.</p>
</section>
<section id="setup" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="setup"><span class="header-section-number">11.3</span> Setup</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflows)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parsnip)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyclust)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra) <span class="co"># trying fviz_nbclust(), which gives elbow, silhouette, and gap statistic</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hopkins)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fpc)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggforce)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"./data/clean_mu_weighted_soil_props.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">"comp_pct"</span>))</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>old_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(d)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>new_names <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(old_names, <span class="st">"_r_value"</span>, <span class="st">""</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(d) <span class="ot">&lt;-</span> new_names</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># this is a dataframe of the results from my first k-means</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># run using same methods as Devine et al. Loading it so I </span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># can use the colors in my PCA plots to get a qualitative </span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># sense of whether we "see" similar clusters after PCA</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>clust_membership <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"data/mukey_cluster_assignments_and_soilprops.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mukey, k_6)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(d, clust_membership, <span class="at">by =</span> <span class="st">"mukey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Reminder of what the data look like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["mukey"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["claytotal"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["om"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["cec7"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["dbthirdbar"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["ec"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["ph1to1h2o"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["caco3"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["lep"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["ksat"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["awc"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["k_6"],"name":[12],"type":["chr"],"align":["left"]}],"data":[{"1":"395973","2":"3.000000","3":"1.50","4":"4.50000","5":"1.600","6":"0","7":"6.000000","8":"0","9":"0.3","10":"282.00000","11":"0.0800000","12":"Cluster_1"},{"1":"395975","2":"3.000000","3":"1.00","4":"4.50000","5":"1.600","6":"0","7":"6.000000","8":"0","9":"0.3","10":"282.00000","11":"0.0800000","12":"Cluster_1"},{"1":"395900","2":"5.000000","3":"4.50","4":"11.37500","5":"1.435","6":"0","7":"7.250000","8":"0","9":"1.5","10":"74.75000","11":"0.0975000","12":"Cluster_1"},{"1":"395948","2":"19.500000","3":"5.00","4":"21.00000","5":"1.400","6":"0","7":"6.500000","8":"0","9":"1.5","10":"9.00000","11":"0.2200000","12":"Cluster_2"},{"1":"885885","2":"7.155556","3":"4.95","4":"17.81667","5":"1.437","6":"0","7":"6.416667","8":"0","9":"1.5","10":"38.27778","11":"0.1396111","12":"Cluster_1"},{"1":"395974","2":"3.000000","3":"1.00","4":"4.50000","5":"1.600","6":"0","7":"6.000000","8":"0","9":"0.3","10":"282.00000","11":"0.0800000","12":"Cluster_1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Reminder of the transformations I chose to improve variable distributions and make them normal-ish.</p>
<ul>
<li>Square root: clay, carbonates</li>
<li>Log10: organic matter, cec, lep, ksat, awc</li>
<li>Cube (^3): bulk density</li>
<li>None: ec, ph</li>
</ul>
</section>
<section id="pre-process-data-build-recipe" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="pre-process-data-build-recipe"><span class="header-section-number">11.4</span> Pre-process data (build recipe)</h2>
<ul>
<li>apply some transformations to achieve more normal distributions,</li>
<li>then standardize (<code>step_normalize</code>) by subtracting the mean and dividing by 1 sd</li>
<li>then PCA</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rec_spec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> d) <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update_role</span>(mukey, <span class="at">new_role =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update_role</span>(k_6, <span class="at">new_role =</span> <span class="st">"cluster_k6"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># note this is log10 (the default is ln)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_log</span>(om, cec7, ksat, awc, lep, <span class="at">base =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">dbthirdbar =</span> dbthirdbar<span class="sc">^</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_sqrt</span>(claytotal, caco3) <span class="sc">%&gt;%</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">num_comp =</span> <span class="dv">10</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>rec_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor:  10
cluster_k6:  1
ID:          1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Log transformation on: om, cec7, ksat, awc, lep</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variable mutation for: dbthirdbar^3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Square root transformation on: claytotal, caco3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Centering and scaling for: all_numeric_predictors()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• PCA extraction with: all_numeric_predictors()</code></pre>
</div>
</div>
</section>
<section id="functions-to-run-pca-visualize-results" class="level2" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="functions-to-run-pca-visualize-results"><span class="header-section-number">11.5</span> Functions to run PCA, visualize results</h2>
<p>This is modified from the “Tidy models with R” book, <a href="https://www.tmwr.org/dimensionality.html#feature-extraction-techniques">section 16.5 “Feature Extraction Techniques”</a>.</p>
<p>I removed the “dat” argument because I’m using the dataset that is already in my recipe. I also set <code>new_data = NULL</code> in bake as a reminder of this. In <code>prep</code>, it is default to have <code>retain=TRUE</code>, but again I’m explicitly typing it as a reminder to myself of what the defaults / where the data is coming from.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>run_pca <span class="ot">&lt;-</span> <span class="cf">function</span>(recipe){</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  recipe <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># here, prep estimates the added PCA step</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>(<span class="at">retain =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process the data (new_data=NULL means use data in recipe)</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>) </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the scatterplot matrix</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>plot_validation_results <span class="ot">&lt;-</span> <span class="cf">function</span>(pca_df) {</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  pca_df <span class="sc">%&gt;%</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> .panel_x,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> .panel_y,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> k_6,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> k_6</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">+</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_autodensity</span>(<span class="at">alpha =</span> .<span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_matrix</span>(<span class="fu">vars</span>(<span class="sc">-</span><span class="fu">c</span>(mukey, k_6)), <span class="at">layer.diag =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="principal-components-analysis-pca" class="level2" data-number="11.6">
<h2 data-number="11.6" class="anchored" data-anchor-id="principal-components-analysis-pca"><span class="header-section-number">11.6</span> Principal Components Analysis (PCA)</h2>
<section id="visualize-pca-results" class="level3" data-number="11.6.1">
<h3 data-number="11.6.1" class="anchored" data-anchor-id="visualize-pca-results"><span class="header-section-number">11.6.1</span> Visualize PCA results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pca_results <span class="ot">&lt;-</span> <span class="fu">run_pca</span>(rec_spec)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(pca_results, <span class="st">"data/pca_scores.csv"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># just plotting the first 5 PCs so we can actually seem them</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>pca_results <span class="sc">%&gt;%</span> </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(mukey, k_6, PC01, PC02, PC03, PC04, PC05, PC06) <span class="sc">%&gt;%</span> </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_validation_results</span>() <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"PCA pairwise plots: colors indicate k_6 clusters from original k-means"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="extract-loadings" class="level3" data-number="11.6.2">
<h3 data-number="11.6.2" class="anchored" data-anchor-id="extract-loadings"><span class="header-section-number">11.6.2</span> Extract loadings</h3>
<p>Took me FOREVER to figure out why I wasn’t able to extract my loadings with the example code from the <code>step_pca</code> <a href="https://recipes.tidymodels.org/reference/step_pca.html#ref-examples">documentation here</a> using <code>tidy(prepped_rec, number = 2, type = "coef")</code>. After much frustration, I figured out that the “number” argument needs to correspond to the PCA step in the tidied dataframe of my prepped recipe… in all the documentation this number is 2, so I kept trying that and getting my bulk density mutation step. In my case, the number is 5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pca_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(rec_spec)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 'type = "coef"' here gets variables loadings per component</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>pca_loadings <span class="ot">&lt;-</span> <span class="fu">tidy</span>(pca_prep, <span class="dv">5</span>, <span class="at">type =</span> <span class="st">"coef"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(pca_loadings, <span class="st">"data/pca_loadings.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ltab <span class="ot">&lt;-</span> loadings_dat <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(terms, value, component) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> component, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> value,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"PC"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>(<span class="at">rowname_col =</span> <span class="st">"terms"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_stubhead</span>(<span class="at">label =</span> <span class="st">"term"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns  =</span> <span class="fu">contains</span>(<span class="st">"PC"</span>),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimals =</span> <span class="dv">2</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sub_missing</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"PC Loadings"</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="fu">gtsave</span>(ltab, <span class="at">filename =</span> <span class="st">"figs/pc_loadings_table.docx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extract-variance" class="level3" data-number="11.6.3">
<h3 data-number="11.6.3" class="anchored" data-anchor-id="extract-variance"><span class="header-section-number">11.6.3</span> Extract variance</h3>
<p><strong>Note</strong> the number of rows in the <code>pca_var</code> dataframe: 40. We have 4 different terms calculated for each component:</p>
<ul>
<li>variance</li>
<li>cumulative variance</li>
<li>percent variance</li>
<li>cumulative percent variance</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pca_var <span class="ot">&lt;-</span> <span class="fu">tidy</span>(pca_prep, <span class="dv">5</span>, <span class="at">type =</span> <span class="st">"variance"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(pca_var, <span class="st">"data/pca_variance.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First we can look at % variance explained by each component:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pca_var <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(terms <span class="sc">==</span> <span class="st">"percent variance"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> component, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span> </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> component, <span class="at">y =</span> value<span class="sc">+</span><span class="dv">2</span>, <span class="at">label =</span> <span class="fu">round</span>(value, <span class="dv">1</span>)), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Percent variation explained"</span>) <span class="sc">+</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Next, we can look at cumulative % explained</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>pca_var <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(terms <span class="sc">==</span> <span class="st">"cumulative percent variance"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> component, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> component, <span class="at">y =</span> value<span class="sc">+</span><span class="dv">2</span>, <span class="at">label =</span> <span class="fu">round</span>(value, <span class="dv">1</span>)), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative percent variation explained"</span>) <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And now a more traditional scree plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pca_var <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(terms <span class="sc">==</span> <span class="st">"variance"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> component, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Variance (Eigenvalue?)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="select-pcs-to-keep" class="level3" data-number="11.6.4">
<h3 data-number="11.6.4" class="anchored" data-anchor-id="select-pcs-to-keep"><span class="header-section-number">11.6.4</span> Select PCs to keep</h3>
<p>For this round, I am keeping the first 5 PCs. This will always be a somewhat subjective decision, something noted by both Jolliffe &amp; Cadima (2016) and the helpfully detailed climate zone paper by Fovell &amp; Fovell 1993 that walks through their process and comparison of 3 vs.&nbsp;5 PCs for their modeling scenario.</p>
<p>Keeping the first 5 PCs accounts for 90% of the variation in my dataset. It also happens to be the number at which all of my original variables have been loaded on at least one PC (PC5 is the first time we see AWC loaded at all).</p>
<p>Might be interesting, like Fovell &amp; Fovell (1993), to do an additional version with 7 PCs. That gets us at &gt;95% variation accounted for.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>dat_for_kmeans <span class="ot">&lt;-</span> pca_results <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mukey, PC01, PC02, PC03, PC04, PC05)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="sec-mod-opt" class="level2" data-number="11.7">
<h2 data-number="11.7" class="anchored" data-anchor-id="sec-mod-opt"><span class="header-section-number">11.7</span> Set model options</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># writing a custom function here so I can be explicit </span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># about the options I'm choosing, and also use within the </span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># list-col framework I set up with map() below. </span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>km_spec <span class="ot">&lt;-</span> <span class="cf">function</span>(nclust){</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  tidyclust<span class="sc">::</span><span class="fu">k_means</span>(<span class="at">num_clusters =</span> nclust) <span class="sc">%&gt;%</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    parsnip<span class="sc">::</span><span class="fu">set_engine</span>(<span class="at">engine =</span> <span class="st">"stats"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">nstart =</span> <span class="dv">10</span>, <span class="co"># 1 is default, &gt;1 recommended</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">algorithm =</span> <span class="st">"Hartigan-Wong"</span>, <span class="co"># H-W is default</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">iter.max =</span> <span class="dv">20</span>) <span class="co"># default is 10, wasn't always enough</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-up-data-structure-and-kmeans-recipe" class="level2" data-number="11.8">
<h2 data-number="11.8" class="anchored" data-anchor-id="set-up-data-structure-and-kmeans-recipe"><span class="header-section-number">11.8</span> Set up data structure and kmeans recipe</h2>
<p>Here I set up a dataframe that will catch my modeling results in list columns of the different model objects and return values. The first column I define specifies the range of different cluster sizes (k) that we will try.</p>
<p>I also set up my recipe here, which is much simpler compared to the original version because all of my data has been processed already before running it through k-means. Per the reading I did on 2023-01-11, especially Green &amp; Krieger (1995) and Schaffer &amp; Green (1998), I’m not further standardizing my component scores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>try_clusts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>km_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">n_clust =</span> try_clusts)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>km_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> dat_for_kmeans) <span class="sc">%&gt;%</span> </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(mukey, <span class="at">new_role =</span> <span class="st">"ID"</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>km_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 5
ID:        1</code></pre>
</div>
</div>
</section>
<section id="specify-model-for-each-value-of-k" class="level2" data-number="11.9">
<h2 data-number="11.9" class="anchored" data-anchor-id="specify-model-for-each-value-of-k"><span class="header-section-number">11.9</span> Specify model (for each value of k)</h2>
<p>For each unique value of k (2-20), this returns a model specification object (in the <code>kmeans_spec</code> column) based on the custom function I wrote above. The model specification has all the options set about how we want the algorithm to run (methods, number of starts, etc.). We need a different one for each value of k.</p>
<p>The <code>kmeans_wflow</code> column here holds our workflow objects. These objects combine our model specification (from <code>kmeans_spec</code>) with the data recipe (preprocessor) we made above (<code>rec_spec</code>, is same for all models).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for each unique value of clusters (2:20), returns a model</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># specification (kmeans_spec) and a workflow (kmeans_wflow) </span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># note that the workflow </span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>km_df <span class="ot">&lt;-</span> km_df <span class="sc">%&gt;%</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">kmeans_spec =</span> <span class="fu">map</span>(n_clust, <span class="sc">~</span> <span class="fu">km_spec</span>(<span class="at">nclust =</span> .x)),</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">kmeans_wflow =</span> <span class="fu">map</span>(kmeans_spec,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span> <span class="fu">workflow</span>(</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">preprocessor =</span> km_rec, <span class="at">spec =</span> .x</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>                       ))</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co"># our current data structure</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(km_df, <span class="at">n=</span><span class="dv">3</span>L )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]},{"label":["kmeans_spec"],"name":[2],"type":["list"],"align":["right"]},{"label":["kmeans_wflow"],"name":[3],"type":["list"],"align":["right"]}],"data":[{"1":"2","2":"<S3: k_means>","3":"<S3: workflow>","_rn_":"1"},{"1":"3","2":"<S3: k_means>","3":"<S3: workflow>","_rn_":"2"},{"1":"4","2":"<S3: k_means>","3":"<S3: workflow>","_rn_":"3"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take a look at an example workflow</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>km_df<span class="sc">$</span>kmeans_wflow[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: k_means()

── Preprocessor ────────────────────────────────────────────────────────────────
0 Recipe Steps

── Model ───────────────────────────────────────────────────────────────────────
K Means Cluster Specification (partition)

Main Arguments:
  num_clusters = nclust

Engine-Specific Arguments:
  nstart = 10
  algorithm = Hartigan-Wong
  iter.max = 20

Computational engine: stats </code></pre>
</div>
</div>
</section>
<section id="fit-the-models" class="level2" data-number="11.10">
<h2 data-number="11.10" class="anchored" data-anchor-id="fit-the-models"><span class="header-section-number">11.10</span> Fit the models</h2>
<p>All the steps above were related to specifying different aspects of this model. Now we can actually fit the models.</p>
<p>Some troubleshooting here:</p>
<ul>
<li>Started by specifying <code>tidyclust::fit()</code> but something weird was happening where my <code>step_normalize()</code> wasn’t included in the pre-processor recipe when I looked at the fitted model object.</li>
<li>If I specify <code>parsnip::fit()</code> , then <code>step_normalize()</code> is included and the values of the cluster centroids are in the expected ranges (centered, scaled).</li>
<li>I also tried this without explicitly specifying the package (so just <code>fit()</code> ) and it worked as expected.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make a quiet version of fit(), so we can capture results </span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and any warning messages from the models </span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># see troubleshooting notes below</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>quiet_fit <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">quietly</span>(<span class="at">.f =</span> parsnip<span class="sc">::</span>fit)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>) <span class="co"># for reproducibility </span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>km_fit_df <span class="ot">&lt;-</span> km_df <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">km_result =</span> <span class="fu">map</span>(<span class="at">.x =</span> kmeans_wflow,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">.f =</span> quiet_fit,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>       <span class="co"># data comes after .f b/c not vectorized over            </span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> dat_for_kmeans),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">km_fit =</span> <span class="fu">map</span>(km_result, <span class="sc">~</span><span class="fu">pluck</span>(.x, <span class="st">'result'</span>)),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">warn =</span> <span class="fu">map</span>(km_fit, <span class="sc">~</span><span class="fu">pluck</span>(.x, <span class="st">'warnings'</span>)),</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">msg =</span> <span class="fu">map</span>(km_fit, <span class="sc">~</span><span class="fu">pluck</span>(.x, <span class="st">'messages'</span>)),</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">n_iter =</span> <span class="fu">map_dbl</span>(km_fit, </span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">~</span><span class="fu">pluck</span>(.x, <span class="st">'fit'</span>, <span class="st">'fit'</span>, <span class="st">'fit'</span>, <span class="st">'iter'</span> ))) </span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co"># check out current data structure</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(km_fit_df, <span class="at">n =</span> <span class="dv">3</span>L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]},{"label":["kmeans_spec"],"name":[2],"type":["list"],"align":["right"]},{"label":["kmeans_wflow"],"name":[3],"type":["list"],"align":["right"]},{"label":["km_result"],"name":[4],"type":["list"],"align":["right"]},{"label":["km_fit"],"name":[5],"type":["list"],"align":["right"]},{"label":["warn"],"name":[6],"type":["list"],"align":["right"]},{"label":["msg"],"name":[7],"type":["list"],"align":["right"]},{"label":["n_iter"],"name":[8],"type":["dbl"],"align":["right"]}],"data":[{"1":"2","2":"<S3: k_means>","3":"<S3: workflow>","4":"<named list [4]>","5":"<S3: workflow>","6":"<NULL>","7":"<NULL>","8":"1","_rn_":"1"},{"1":"3","2":"<S3: k_means>","3":"<S3: workflow>","4":"<named list [4]>","5":"<S3: workflow>","6":"<NULL>","7":"<NULL>","8":"3","_rn_":"2"},{"1":"4","2":"<S3: k_means>","3":"<S3: workflow>","4":"<named list [4]>","5":"<S3: workflow>","6":"<NULL>","7":"<NULL>","8":"3","_rn_":"3"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># don't need anymore, cleaning up</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(km_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="view-messages-warnings" class="level3" data-number="11.10.1">
<h3 data-number="11.10.1" class="anchored" data-anchor-id="view-messages-warnings"><span class="header-section-number">11.10.1</span> View messages &amp; warnings</h3>
<p>We can look at any warnings or messages from the modeling process:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>km_fit_df <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, warn, msg, n_iter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]},{"label":["warn"],"name":[2],"type":["list"],"align":["right"]},{"label":["msg"],"name":[3],"type":["list"],"align":["right"]},{"label":["n_iter"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"2","2":"<NULL>","3":"<NULL>","4":"1"},{"1":"3","2":"<NULL>","3":"<NULL>","4":"3"},{"1":"4","2":"<NULL>","3":"<NULL>","4":"3"},{"1":"5","2":"<NULL>","3":"<NULL>","4":"4"},{"1":"6","2":"<NULL>","3":"<NULL>","4":"5"},{"1":"7","2":"<NULL>","3":"<NULL>","4":"4"},{"1":"8","2":"<NULL>","3":"<NULL>","4":"5"},{"1":"9","2":"<NULL>","3":"<NULL>","4":"4"},{"1":"10","2":"<NULL>","3":"<NULL>","4":"4"},{"1":"11","2":"<NULL>","3":"<NULL>","4":"4"},{"1":"12","2":"<NULL>","3":"<NULL>","4":"4"},{"1":"13","2":"<NULL>","3":"<NULL>","4":"6"},{"1":"14","2":"<NULL>","3":"<NULL>","4":"7"},{"1":"15","2":"<NULL>","3":"<NULL>","4":"6"},{"1":"16","2":"<NULL>","3":"<NULL>","4":"5"},{"1":"17","2":"<NULL>","3":"<NULL>","4":"6"},{"1":"18","2":"<NULL>","3":"<NULL>","4":"4"},{"1":"19","2":"<NULL>","3":"<NULL>","4":"4"},{"1":"20","2":"<NULL>","3":"<NULL>","4":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="look-at-one-fit-object" class="level3" data-number="11.10.2">
<h3 data-number="11.10.2" class="anchored" data-anchor-id="look-at-one-fit-object"><span class="header-section-number">11.10.2</span> Look at one fit object</h3>
<p>As an example, these are what the fitted objects look like.</p>
<p><strong>NOTE</strong> the clustering vector here is using the cluster numbers directly from <code>kmeans()</code>. <code>tidyclust</code> assigns names like “Cluster_1”, “Cluster_2” etc. , but the numbers do NOT necessarily match with what <code>kmeans()</code> returns. The CLUSTERINGS are the same, but the numbers are not necessarily so. So 2 in this “Clustering Vector” below is NOT necessarily equal to tidyclust “Cluster_2” that you might get by using the <code>extract_cluster_assignment</code> function. To keep things consistent, I’m always using the cluster names assigned by <code>tidyclust</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>examp_fit <span class="ot">&lt;-</span> km_fit_df<span class="sc">$</span>km_result[[<span class="dv">4</span>]][[<span class="st">'result'</span>]]</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>examp_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: k_means()

── Preprocessor ────────────────────────────────────────────────────────────────
0 Recipe Steps

── Model ───────────────────────────────────────────────────────────────────────
K-means clustering with 5 clusters of sizes 1463, 431, 1809, 1096, 2073

Cluster means:
        PC01       PC02        PC03         PC04       PC05
1  1.5136139 -1.1675498 -0.04287291 -1.011715005 -0.1041855
2  1.7443425 -2.6232190 -0.74284903  2.312509274 -0.1599810
3  1.6349352  1.1528420 -0.02833620  0.175076730  0.2152876
4 -3.7357281 -0.3166354 -0.15275027 -0.001684125  0.4859401
5 -0.8825222  0.5307642  0.29019078  0.081321539 -0.3379982

Clustering vector:
   [1] 4 4 4 5 5 4 4 4 4 4 5 4 4 5 4 3 5 5 4 4 5 5 4 4 5 4 4 4 4 4 5 5 4 4 4 4 4
  [38] 5 5 5 4 4 4 4 4 5 4 4 4 4 4 5 5 5 3 1 1 5 3 3 3 3 3 2 4 4 4 4 1 1 3 3 4 4
  [75] 1 4 1 5 5 5 3 3 3 2 1 4 4 4 4 4 4 4 3 4 4 1 5 4 4 4 3 3 1 1 1 1 4 4 5 5 5
 [112] 4 4 4 3 1 4 4 4 4 1 3 3 3 3 4 4 4 4 5 5 4 4 4 4 5 4 5 1 5 4 4 4 4 4 4 1 4
 [149] 4 4 1 5 5 3 2 5 2 4 5 5 5 4 1 1 1 1 5 5 4 4 4 5 5 4 4 5 5 1 1 1 5 3 5 5 3
 [186] 1 1 3 3 3 5 5 1 3 5 5 5 5 4 4 4 4 4 4 4 5 3 3 3 3 3 3 3 3 3 3 3 3 3 1 3 1
 [223] 1 3 4 4 3 3 3 1 4 4 4 3 3 4 1 5 3 3 4 5 1 1 5 3 4 3 3 2 4 4 4 5 2 5 4 4 1
 [260] 4 1 4 4 4 4 5 4 4 5 4 4 4 4 4 4 4 4 5 5 5 5 4 4 5 5 4 4 4 5 4 4 4 4 5 5 5
 [297] 5 5 4 4 4 4 5 4 5 4 4 5 5 5 5 5 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 5 4 4 4 4 4
 [334] 5 5 5 2 3 1 1 2 2 2 2 1 2 1 1 3 3 1 1 3 2 1 3 3 1 1 2 5 1 3 1 1 5 2 1 1 3
 [371] 5 5 3 5 5 3 3 2 5 3 4 4 1 1 3 3 3 3 3 3 3 3 3 3 3 3 3 1 3 1 1 3 3 3 1 1 1
 [408] 1 1 3 5 5 3 3 3 3 5 5 5 5 3 5 3 5 5 1 1 1 3 5 3 5 5 5 3 3 3 4 4 4 3 3 4 5
 [445] 5 3 3 3 3 3 1 3 3 3 3 1 4 3 4 4 5 3 3 3 3 5 3 3 3 1 1 3 3 3 3 3 1 3 3 3 3
 [482] 1 3 5 5 5 1 5 5 3 3 5 3 3 3 1 5 3 3 3 1 3 3 1 1 1 3 3 3 1 3 3 3 3 3 3 3 1
 [519] 5 5 1 1 1 3 3 3 3 3 4 4 5 5 3 3 3 5 5 3 3 5 5 1 3 5 1 1 5 4 5 1 1 2 5 4 5
 [556] 5 1 5 1 5 1 1 1 1 5 5 1 1 1 1 1 3 1 5 1 5 3 3 1 5 1 1 1 3 1 3 1 1 1 5 5 5
 [593] 3 3 1 1 1 3 3 1 5 4 1 3 3 5 3 3 1 3 4 5 5 5 1 5 1 5 3 3 3 3 3 3 1 1 1 1 1
 [630] 5 3 3 3 3 5 5 5 5 3 5 5 5 1 3 3 3 5 5 5 5 3 3 3 3 5 1 1 1 4 4 4 4 5 5 5 5
 [667] 5 1 5 5 5 5 5 5 5 5 5 5 3 5 5 5 4 3 3 3 3 3 3 3 3 3 4 4 4 4 4 4 5 5 5 5 4
 [704] 4 5 4 4 4 4 4 4 4 4 4 4 4 4 5 4 4 4 4 4 4 4 4 5 4 4 4 1 5 5 4 4 5 4 4 5 4
 [741] 4 4 4 4 5 4 4 5 4 4 1 1 1 1 1 5 1 5 5 4 1 3 5 3 5 1 3 1 1 3 5 3 3 5 3 3 1
 [778] 1 2 1 1 1 1 1 1 5 5 4 4 1 3 3 1 3 3 5 3 1 3 3 1 1 1 1 5 1 1 1 5 3 1 1 1 1
 [815] 3 1 1 1 1 1 1 1 1 5 5 5 3 3 5 5 3 3 3 1 3 3 1 1 5 5 5 5 5 4 1 1 1 3 2 3 3
 [852] 3 2 1 1 2 1 2 2 3 3 3 2 2 2 2 5 2 2 2 2 2 2 5 4 4 2 5 2 2 4 4 4 2 5 5 4 5
 [889] 5 1 3 3 3 1 3 1 3 1 2 1 1 3 3 2 4 2 5 1 1 3 3 4 1 1 1 1 1 2 2 2 5 2 2 5 2
 [926] 2 2 2 2 2 3 5 5 3 4 5 2 2 2 3 3 1 3 4 4 4 4 3 3 2 1 1 2 2 2 4 4 1 4 4 5 5
 [963] 5 3 1 3 1 4 4 4 3 3 1 1 5 5 4 4 1 5 3 4 5 4 4 4 5 1 1 5 4 4 4 4 3 3 3 2 4
[1000] 4 5 3 2 5 2 5 4 1 4 4 4 4 4 1 5 5 1 1 5 5 5 5 1 3 3 3 1 1 1 5 1 5 5 3 1 1
[1037] 1 1 3 3 1 5 1 1 1 5 5 1 3 3 3 3 4 4 1 3 3 3 3 3 3 3 1 5 5 1 1 3 3 3 1 5 5
[1074] 1 3 3 5 3 1 3 3 1 1 1 5 5 1 1 1 1 3 3 3 3 3 3 3 3 1 1 1 3 1 1 3 3 1 1 1 5
[1111] 5 5 3 5 3 3 1 1 1 3 3 1 3 3 3 4 1 3 3 3 4 4 4 4 4 1 4 5 4 4 4 4 4 4 4 4 4
[1148] 4 4 4 3 4 4 4 4 5 4 4 4 5 3 5 4 4 4 4 4 4 4 4 3 5 1 5 4 3 5 3 5 5 4 4 4 4
[1185] 4 4 4 5 5 5 5 5 4 5 4 4 4 5 3 5 5 5 5 4 4 4 4 4 3 3 4 4 4 5 5 3 3 5 3 5 5
[1222] 3 3 1 5 5 4 4 4 5 5 3 5 5 5 5 1 1 5 5 5 5 5 5 3 3 3 3 1 5 5 5 5 5 5 4 4 4
[1259] 1 5 5 5 5 5 5 5 5 4 4 1 1 1 4 3 5 3 5 5 5 4 5 5 5 5 3 3 3 5 5 5 3 5 5 5 5
[1296] 4 4 4 4 1 3 3 3 3 3 5 5 5 1 5 5 5 3 5 3 1 1 4 4 4 5 5 4 5 2 2 5 3 1 3 5 1
[1333] 1 3 3 1 3 1 3 1 1 1 3 2 1 5 5 1 1 1 1 1 1 5 5 5 5 5 4 5 5 5 5 5 5 5 5 5 5
[1370] 3 3 1 3 1 3 3 4 4 4 4 5 5 5 5 5 3 1 3 3 5 3 3 3 3 4 5 5 5 5 5 5 5 1 5 5 3
[1407] 3 3 3 3 3 1 1 1 1 3 1 3 3 1 5 1 1 3 1 1 3 1 1 5 5 3 3 3 1 3 3 3 3 3 3 1 1

...
and 156 more lines.</code></pre>
</div>
</div>
<p>A nicer way to look at the results is by accessing specific parts of the fitted model object, as below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># some basic model metrics</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(examp_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["totss"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["tot.withinss"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["betweenss"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["iter"],"name":[4],"type":["int"],"align":["right"]}],"data":[{"1":"61861.2","2":"22474.31","3":"39386.89","4":"4"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># centroid data (transformed/standardized scale)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>centroids <span class="ot">&lt;-</span> tidyclust<span class="sc">::</span><span class="fu">extract_centroids</span>(examp_fit)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>centroids</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".cluster"],"name":[1],"type":["fct"],"align":["left"]},{"label":["PC01"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["PC02"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["PC03"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["PC04"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["PC05"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"Cluster_1","2":"-3.7357281","3":"-0.3166354","4":"-0.15275027","5":"-0.001684125","6":"0.4859401"},{"1":"Cluster_2","2":"-0.8825222","3":"0.5307642","4":"0.29019078","5":"0.081321539","6":"-0.3379982"},{"1":"Cluster_3","2":"1.6349352","3":"1.1528420","4":"-0.02833620","5":"0.175076730","6":"0.2152876"},{"1":"Cluster_4","2":"1.5136139","3":"-1.1675498","4":"-0.04287291","5":"-1.011715005","6":"-0.1041855"},{"1":"Cluster_5","2":"1.7443425","3":"-2.6232190","4":"-0.74284903","5":"2.312509274","6":"-0.1599810"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># helpful to add to future plots for examining indiv. clusters</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>clust_stat <span class="ot">&lt;-</span> tidyclust<span class="sc">::</span><span class="fu">sse_within</span>(examp_fit)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>clust_stat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".cluster"],"name":[1],"type":["fct"],"align":["left"]},{"label":["wss"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["n_members"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"Cluster_1","2":"3150.346","3":"1096"},{"1":"Cluster_2","2":"4606.289","3":"2073"},{"1":"Cluster_3","2":"6763.020","3":"1809"},{"1":"Cluster_4","2":"4748.878","3":"1463"},{"1":"Cluster_5","2":"3205.773","3":"431"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
</section>
<section id="sec-mod-metrics" class="level2" data-number="11.11">
<h2 data-number="11.11" class="anchored" data-anchor-id="sec-mod-metrics"><span class="header-section-number">11.11</span> Model metrics</h2>
<p>See also section 7.5 in the Chapter by Tan et al.&nbsp;for more about cluster evaluation.</p>
<section id="extract-metrics" class="level3" data-number="11.11.1">
<h3 data-number="11.11.1" class="anchored" data-anchor-id="extract-metrics"><span class="header-section-number">11.11.1</span> Extract metrics</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="ot">&lt;-</span> km_fit_df <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tot_sse = total sum of squared error</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_sse =</span> <span class="fu">map_dbl</span>(km_fit, <span class="sc">~</span> <span class="fu">sse_total_vec</span>(.x)),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tot_wss = sum of within-cluster sse</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tot_wss =</span> <span class="fu">map_dbl</span>(km_fit, <span class="sc">~</span><span class="fu">sse_within_total_vec</span>(.x)),</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sse ratio = wss / total sse, </span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sse_ratio =</span> <span class="fu">map_dbl</span>(km_fit, <span class="sc">~</span><span class="fu">sse_ratio_vec</span>(.x))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(km_fit_df)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>metrics_simple <span class="ot">&lt;-</span> metrics_df <span class="sc">%&gt;%</span> </span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, tot_sse, tot_wss, sse_ratio)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>metrics_simple</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["n_clust"],"name":[1],"type":["int"],"align":["right"]},{"label":["tot_sse"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["tot_wss"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["sse_ratio"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"2","2":"61861.2","3":"39055.772","4":"0.6313452"},{"1":"3","2":"61861.2","3":"31115.600","4":"0.5029906"},{"1":"4","2":"61861.2","3":"26545.763","4":"0.4291181"},{"1":"5","2":"61861.2","3":"22474.306","4":"0.3633021"},{"1":"6","2":"61861.2","3":"19465.419","4":"0.3146628"},{"1":"7","2":"61861.2","3":"17060.585","4":"0.2757881"},{"1":"8","2":"61861.2","3":"15432.422","4":"0.2494685"},{"1":"9","2":"61861.2","3":"14516.457","4":"0.2346617"},{"1":"10","2":"61861.2","3":"13348.700","4":"0.2157847"},{"1":"11","2":"61861.2","3":"12567.155","4":"0.2031508"},{"1":"12","2":"61861.2","3":"12114.468","4":"0.1958331"},{"1":"13","2":"61861.2","3":"11319.202","4":"0.1829774"},{"1":"14","2":"61861.2","3":"10785.308","4":"0.1743469"},{"1":"15","2":"61861.2","3":"10509.792","4":"0.1698931"},{"1":"16","2":"61861.2","3":"10075.480","4":"0.1628724"},{"1":"17","2":"61861.2","3":"9537.115","4":"0.1541696"},{"1":"18","2":"61861.2","3":"9228.785","4":"0.1491853"},{"1":"19","2":"61861.2","3":"8843.186","4":"0.1429521"},{"1":"20","2":"61861.2","3":"8534.301","4":"0.1379589"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(pca_prep)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(rec_spec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-total-wss" class="level3" data-number="11.11.2">
<h3 data-number="11.11.2" class="anchored" data-anchor-id="plot-total-wss"><span class="header-section-number">11.11.2</span> Plot Total WSS</h3>
<p>Not a clear “elbow” here, although by the time we get to 10-11 it does seem to be leveling off.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>metrics_simple <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_clust, <span class="at">y =</span> tot_wss)) <span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"k (number clusters)"</span>) <span class="sc">+</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"sum of within-cluster sse"</span>) <span class="sc">+</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Compare values of k: looking for elbow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>metrics_simple <span class="sc">%&gt;%</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_clust <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">12</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_clust, <span class="at">y =</span> tot_wss)) <span class="sc">+</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"k (number clusters)"</span>) <span class="sc">+</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"sum of within-cluster sse"</span>) <span class="sc">+</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Zoom in a bit: looking for elbow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="average-silhouette" class="level3" data-number="11.11.3">
<h3 data-number="11.11.3" class="anchored" data-anchor-id="average-silhouette"><span class="header-section-number">11.11.3</span> Average Silhouette</h3>
<p>From the <code>{tidyclust}</code> documentation:</p>
<blockquote class="blockquote">
<p>Another common measure of cluster structure is called the <strong>silhouette</strong>. The silhouette of a single observation is proportional to the average distance from that observation to within-cluster observations minus the average distance to outside-cluster observations; normalized by the greater of these two average.<br>
</p>
<p>In principle, a large silhouette (close to 1) suggests that an observation is more similar to those within its cluster than those outside its cluster.</p>
</blockquote>
<p>See also pg. 581 in Tan2018 Chap 7 Cluster Analysis: Basic Concepts and Algorithms</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>prepped_rec <span class="ot">&lt;-</span> <span class="fu">prep</span>(km_rec, <span class="at">retain=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># using NULL here for new_data b/c I want the </span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pre-processed training data </span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>baked_df <span class="ot">&lt;-</span> <span class="fu">bake</span>(prepped_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>mukey) </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>dists <span class="ot">&lt;-</span> baked_df <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span> <span class="fu">dist</span>(<span class="at">method =</span> <span class="st">"euclidean"</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>silh_df <span class="ot">&lt;-</span> metrics_df <span class="sc">%&gt;%</span> </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_sil =</span> <span class="fu">map_dbl</span>(km_fit, </span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>                       tidyclust<span class="sc">::</span>silhouette_avg_vec,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">dists =</span> dists),</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">indiv_sil =</span> <span class="fu">map</span>(km_fit, </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>                         tidyclust<span class="sc">::</span>silhouette,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">dists =</span> dists))</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>indiv_sil_df <span class="ot">&lt;-</span> silh_df <span class="sc">%&gt;%</span> <span class="fu">select</span>(n_clust, indiv_sil) <span class="sc">%&gt;%</span> </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(indiv_sil) <span class="sc">%&gt;%</span> </span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(cluster, neighbor),</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">.fns =</span> as.character))</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(indiv_sil_df, <span class="st">"data/pca_kmeans_point_silhouettes.csv"</span>)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(metrics_df)  </span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(dists)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(prepped_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Higher silhouette is better (means observations are closer to their centroids than to other observations). Seems to suggest that 4, 6, 8, 11 would be OK</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>silh_df <span class="sc">%&gt;%</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_clust, <span class="at">y =</span> avg_sil)) <span class="sc">+</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Overall Average Silhouette"</span>) <span class="sc">+</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Higher is better, possible values [-1,1]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Can also plot the individual silhouettes. For each clustering (model version), we have a silhouette value per observation in the dataset (n=6872). We also have the closest “neighbor” cluster, or the cluster that specific observation would belong to if its home cluster didn’t exist.</p>
<p>Here’s an example of this data for the k=6 clustering. The</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>neighbor_counts <span class="ot">&lt;-</span> indiv_sil_df <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(n_clust, cluster, neighbor) <span class="sc">%&gt;%</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>()  <span class="sc">%&gt;%</span> </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">str_replace</span>(cluster, <span class="st">"Cluster_"</span>, <span class="st">"c"</span>),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">neighbor =</span> <span class="fu">str_replace</span>(neighbor, <span class="st">"Cluster_"</span>, <span class="st">"c"</span>))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>k6_neighbor_counts <span class="ot">&lt;-</span> neighbor_counts <span class="sc">%&gt;%</span> </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_clust <span class="sc">==</span> <span class="dv">6</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>indiv_sil_df <span class="sc">%&gt;%</span> </span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(cluster, neighbor),</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>         <span class="sc">~</span><span class="fu">str_replace</span>(.x, <span class="st">"Cluster_"</span>, <span class="st">"c"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_clust <span class="sc">==</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> neighbor, <span class="at">y =</span> sil_width)) <span class="sc">+</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> neighbor, <span class="at">y =</span> sil_width),</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.1</span>),</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.2</span>,</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"pink"</span>) <span class="sc">+</span> </span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> k6_neighbor_counts,</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> neighbor, <span class="at">y =</span> <span class="fl">0.7</span>, <span class="at">label =</span> n),</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cluster), <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"k=6 silhouettes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>clust_sil_avgs <span class="ot">&lt;-</span> indiv_sil_df <span class="sc">%&gt;%</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>           n_clust) <span class="sc">%&gt;%</span> </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_sil =</span> <span class="fu">mean</span>(sil_width),</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd_sil =</span> <span class="fu">sd</span>(sil_width), </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>clust_sil_avgs <span class="sc">%&gt;%</span> </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">str_replace</span>(cluster, <span class="st">"Cluster_"</span>, <span class="st">"c0"</span>),</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">cluster =</span> <span class="fu">case_when</span>(</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>           cluster <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"c010"</span>, <span class="st">"c011"</span>, <span class="st">"c012"</span>, <span class="st">"c013"</span>, <span class="st">"c014"</span>, <span class="st">"c015"</span>, <span class="st">"c016"</span>,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"c017"</span>, <span class="st">"c018"</span>, <span class="st">"c019"</span>, <span class="st">"c020"</span>) <span class="sc">~</span> <span class="fu">str_replace</span>(cluster, <span class="st">"c0"</span>, <span class="st">"c"</span>),</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>           <span class="cn">TRUE</span> <span class="sc">~</span> cluster</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>         )) <span class="sc">%&gt;%</span> </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_clust <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6</span><span class="sc">:</span><span class="dv">12</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> cluster, <span class="at">x =</span> mean_sil)) <span class="sc">+</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(n_clust), <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span> </span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Average silhouette width per cluster for k=6-12"</span>) <span class="sc">+</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="not-used-gap-statistic" class="level3" data-number="11.11.4">
<h3 data-number="11.11.4" class="anchored" data-anchor-id="not-used-gap-statistic"><span class="header-section-number">11.11.4</span> Not used: Gap statistic</h3>
<p>For <code>fviz_nbclust()</code>, first couple times running this, got <code>Warning: Quick-TRANSFER stage steps exceeded maximum…</code> Looking online, this seems to be a problem with the model not converging. I added some arguments here that are passed on to <code>kmeans()</code>, to make sure that the algorithm settings here match what I run above, including <code>set.seed()</code></p>
<p>Continued to get warnings, even though I’m using all the same settings as I use for kmeans up above. Not sure why this is, but I’m not going to spend any more time on it right now. Maybe see if getting the gap statistic through <code>NbClust</code> works better? (Later note: NbClust won’t be a good option either, I can’t alter important kmeans() settings in NbClust). Expect it will take a long time either way, consider running this in a separate script and pulling in the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_gap_stat</span>(<span class="at">x =</span> baked_df, </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">FUNcluster =</span> kmeans,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"gap_stat"</span>),</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">k.max =</span> <span class="dv">10</span>, <span class="co"># only considering 2-10 clusters</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">nboot =</span> <span class="dv">50</span>, <span class="co"># default is 100</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">iter.max =</span> <span class="dv">20</span>, <span class="co"># passed to kmeans</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">nstart =</span> <span class="dv">10</span> <span class="co"># passed to kmeans</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>             )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calinski-harabasz-index" class="level3" data-number="11.11.5">
<h3 data-number="11.11.5" class="anchored" data-anchor-id="calinski-harabasz-index"><span class="header-section-number">11.11.5</span> Calinski-Harabasz index</h3>
<p><strong>Not used: <code>{NbClust}</code></strong> <strong>, using <code>{fpc}</code> instead.</strong></p>
<ul>
<li>For Calinski-Harabasz index, higher values are better</li>
<li>Realized after setting this up with <code>NbClust</code> that I don’t have the option to pass additional arguments to the <code>kmeans</code> function here. So I can’t make the algorithm settings exactly match my main clustering pipeline above (where I implement k-means using <code>tidyclust</code> and the <code>tidymodels</code> framework, and where I save the results for further analysis). This is a problem because I know from my original tests that I need to change the iter.max value to avoid non-convergence issues, and I also want to change nstart because nstart &gt;1 is typically known to be best practice (find citation for this).</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># keeping this here as a record, but I"m NOT USING this function for the C-H index. </span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>nbc_indices <span class="ot">&lt;-</span> NbClust<span class="sc">::</span><span class="fu">NbClust</span>(<span class="at">data =</span> baked_df,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">distance =</span> <span class="st">"euclidean"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">"kmeans"</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">min.nc =</span> <span class="dv">2</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">max.nc =</span> <span class="dv">20</span>,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">index =</span> <span class="st">"ch"</span>) <span class="co"># Calinski and Harabasz</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># enframe turns a named vector into a dataframe</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>ch_index_vals <span class="ot">&lt;-</span> <span class="fu">enframe</span>(nbc_indices<span class="sc">$</span>All.index) <span class="sc">%&gt;%</span> </span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">as.integer</span>(name)) <span class="sc">%&gt;%</span> </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">n_clust =</span> name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Trying a different implementation of the Calinski-Harabasz index from the <code>{fpc}</code> package. This is preferred to the above approach, where I originally used the <code>NbClust</code> function from <code>{NbClust}</code> package because I can give this function my clustering generated above (NbClust does its own run of kmeans but I can’t customize it to keep it consistent with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calinhara wants an observations/variables matrix</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as first argument (as opposed to a distance matrix)</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>obsvar_mx <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(baked_df)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co"># function to extract and modify tidyclust clusters</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># into a integer vector, which I will pass to calinhara()</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>create_clust_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(fit_obj){</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_cluster_assignment</span>(fit_obj) <span class="sc">%&gt;%</span> </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(.cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace</span>(., <span class="st">"Cluster_"</span>, <span class="st">""</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.integer</span>()</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="co"># apply function to extract clusterings as integer vectors</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="co"># map to get a c-h index value for every value of k (2-20)</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>ch_metrics <span class="ot">&lt;-</span> silh_df <span class="sc">%&gt;%</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, km_fit) <span class="sc">%&gt;%</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">clustering_vec =</span> <span class="fu">map</span>(km_fit, create_clust_vec),</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">ch_index =</span> <span class="fu">map_dbl</span>(clustering_vec,</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>                       <span class="sc">~</span> fpc<span class="sc">::</span><span class="fu">calinhara</span>(<span class="at">x =</span> obsvar_mx,</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">clustering =</span> .x)</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>ch_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_clust, <span class="at">y =</span> ch_index)) <span class="sc">+</span> </span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Calinski-Harabasz index"</span>) <span class="sc">+</span> </span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Calinski-Harabasz"</span>) <span class="sc">+</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Higher is better"</span>) <span class="sc">+</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hopkins-statistic" class="level3" data-number="11.11.6">
<h3 data-number="11.11.6" class="anchored" data-anchor-id="hopkins-statistic"><span class="header-section-number">11.11.6</span> Hopkins Statistic</h3>
<p>Using the <a href="https://kwstat.github.io/hopkins/reference/hopkins.html"><code>{hopkins}</code></a> package for this. Citations included in the package documentation (also cite Tan et al., 2019 who give an example of using this for evaluating kmeans clusters).</p>
<ul>
<li>Hopkins, B. and Skellam, J.G., 1954. A new method for determining the type of distribution of plant individuals. Annals of Botany, 18(2), pp.213-227.</li>
<li>Cross, G. R., and A. K. Jain. (1982). Measurement of clustering tendency. Theory and Application of Digital Control. Pergamon, 1982. 315-320.</li>
</ul>
<p>And a third citation, helpful illustrations:</p>
<ul>
<li>Lawson, R. G., &amp; Jurs, P. C. (1990). New index for clustering tendency and its application to chemical problems. Journal of Chemical Information and Computer Sciences, 30(1), 36–41. https://doi.org/10.1021/ci00065a010</li>
</ul>
<p>Apparently <code>{factoextra}</code> also has a Hopkins statistic, try that here too. (It takes a very long time to run, but returns 0.93, similar to 0.99 returned by <code>hopkins::hopkins()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>hstat <span class="ot">&lt;-</span> <span class="fu">hopkins</span>(<span class="at">X =</span> baked_df,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># default, number of rows to sample from the df</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">m =</span> <span class="fu">ceiling</span>(<span class="fu">nrow</span>(baked_df)<span class="sc">/</span><span class="dv">10</span>), </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># default, dimension of the data</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">d =</span> <span class="fu">ncol</span>(baked_df),</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># default, kth nearest neighbor to find</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">k =</span> <span class="dv">1</span>) </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>hstat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9999673</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hopkins.pval</span>(<span class="at">x =</span> hstat,</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>             <span class="co"># this is the default for hopkins() above</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="fu">ceiling</span>(<span class="fu">nrow</span>(baked_df)<span class="sc">/</span><span class="dv">10</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># below gives 0.9331899 as the result</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># which agrees with above</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co"># commenting out because it takes a very long time to run</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># factoextra::get_clust_tendency(data = baked_df,</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                                n = 687, </span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co">#                                graph = FALSE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wss-and-silhouette-metrics-on-one-plot" class="level3" data-number="11.11.7">
<h3 data-number="11.11.7" class="anchored" data-anchor-id="wss-and-silhouette-metrics-on-one-plot"><span class="header-section-number">11.11.7</span> WSS and Silhouette metrics on one plot</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>sil_totwss <span class="ot">&lt;-</span> silh_df <span class="sc">%&gt;%</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, avg_sil, tot_wss, tot_sse, sse_ratio)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>ch <span class="ot">&lt;-</span> ch_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, ch_index)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>met_combined <span class="ot">&lt;-</span> <span class="fu">left_join</span>(sil_totwss, ch, <span class="at">by =</span> <span class="st">"n_clust"</span>)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(met_combined, <span class="st">"data/pca_kmeans_cluster_metrics.csv"</span>)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>met2 <span class="ot">&lt;-</span> met_combined <span class="sc">%&gt;%</span> </span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(<span class="st">'n_clust'</span>), <span class="at">names_to =</span> <span class="st">"metric"</span>,</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>met2 <span class="sc">%&gt;%</span> </span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n_clust, <span class="at">y =</span> value)) <span class="sc">+</span> </span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>)) <span class="sc">+</span> </span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(metric), <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="22-pca-kmeans_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="save-model-fits" class="level2" data-number="11.12">
<h2 data-number="11.12" class="anchored" data-anchor-id="save-model-fits"><span class="header-section-number">11.12</span> Save model fits</h2>
<p>Will save these as Rdata so I can call them up and investigate the cluster centroids more closely in the next chapter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>pca_mods <span class="ot">&lt;-</span> silh_df <span class="sc">%&gt;%</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, km_fit)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(pca_mods, <span class="at">file =</span> <span class="st">"data/fitted_pca_kmeans_mods.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="save-cluster-assignments" class="level2" data-number="11.13">
<h2 data-number="11.13" class="anchored" data-anchor-id="save-cluster-assignments"><span class="header-section-number">11.13</span> Save cluster assignments</h2>
<p>For each version of the model (each value of k, different numbers of clusters), a MUKEY is assigned to a specific cluster. Here, I’m pulling that data, shaping it into one dataframe (one row per MUKEY, cluster assingments in separate columns). I’m also adding back in the soil property data so we can use this in the next step when evaluating different cluster sizes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>clust_assign_df <span class="ot">&lt;-</span> pca_mods <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">clust_assign =</span> <span class="fu">map</span>(km_fit, <span class="sc">~</span><span class="fu">augment</span>(.x, <span class="at">new_data =</span> dat_for_kmeans)),</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">mukey_clust =</span> <span class="fu">map</span>(clust_assign, <span class="sc">~</span><span class="fu">select</span>(.x, mukey, .pred_cluster)))</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>assign_mukey_df <span class="ot">&lt;-</span> clust_assign_df <span class="sc">%&gt;%</span> </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n_clust, mukey_clust) <span class="sc">%&gt;%</span> </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(mukey_clust) <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> n_clust, <span class="at">values_from =</span> .pred_cluster, <span class="at">names_prefix =</span> <span class="st">"k_"</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="co"># drop k_6 column from d (it was from orig k-means clusters,</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="co"># used above for viz purposes only)</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>soil_props <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>k_6) </span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>clust_props <span class="ot">&lt;-</span> <span class="fu">full_join</span>(soil_props, assign_mukey_df, <span class="at">by =</span> <span class="st">"mukey"</span>)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(clust_props, <span class="st">"data/pca_mukey_cluster_assignments_and_soilprops.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./11-implement-kmeans.html" class="pagination-link" aria-label="Implement k-means">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Implement k-means</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./23-pca-kmeans-finalists.html" class="pagination-link" aria-label="Clustering Finalists">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Clustering Finalists</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>