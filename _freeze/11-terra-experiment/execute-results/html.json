{
  "hash": "e014c08d71f2054cff170297cca8c2a6",
  "result": {
    "markdown": "# Experiment with terra package {#sec-terra-ex}\n\n## Load packages and data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readr)\nlibrary(dplyr)\nlibrary(terra)\n\n\nr <- rast(\"data/gSSURGO_MN/MapunitRaster_10m_Clip1_and_Reclass/MapunitRaster_10m_Clip1_and_Reclass/Reclass_tif1.tif\")\n\naoi_mu <- read.delim(\"data/gSSURGO_MN/mukey_new_crosswalk.txt\", sep = \",\") %>% \n  select(MUKEY, MUKEY_New, Count)\n\n# to make a thematic EC map\nec_cat <- read_csv(\"data/ec_category_mukey.csv\") %>%\n  full_join(., aoi_mu, by = c(\"mukey\" = \"MUKEY\")) %>% \n  mutate(ec_cat = case_when(\n    is.na(ec_cat) ~ 5,\n    TRUE ~ ec_cat\n  ))\n\nlep_cat <- read_csv(\"data/lep_category_mukey.csv\")%>% \n  full_join(., aoi_mu, by = c(\"mukey\" = \"MUKEY\")) %>% \n  mutate(lep_cat = case_when(\n    is.na(lep_cat) ~ 5,\n    TRUE ~ lep_cat\n  ))\n```\n:::\n\n\n## SpatRaster object\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nclass       : SpatRaster \ndimensions  : 61033, 47668, 1  (nrow, ncol, nlyr)\nresolution  : 10, 10  (x, y)\nextent      : -91855, 384825, 2278555, 2888885  (xmin, xmax, ymin, ymax)\ncoord. ref. : NAD_1983_Albers \nsource      : Reclass_tif1.tif \nname        : Reclass_tif1 \nmin value   :            0 \nmax value   :         7861 \n```\n:::\n:::\n\n\n## Classify cell values\n\nFirst, try making a thematic map with the EC categories I loaded above.\nWill use `terra::classify()` to assign new values to my raster cells.\nNeed to supply a two-column matrix for the reclass, with \"from\" (first column) and \"to\" (second column) values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 7999 is the missing data value\nec_mx <- ec_cat %>% \n  select(MUKEY_New, ec_cat) %>% \n  add_row(MUKEY_New = 7999, ec_cat = 5) %>% \n  as.matrix()\n```\n:::\n\n\nI'm going to do one for LEP too:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 7999 is the missing data value\nlep_mx <- lep_cat %>% \n  select(MUKEY_New, lep_cat) %>% \n  add_row(MUKEY_New = 7999, lep_cat = 5) %>% \n  as.matrix()\n```\n:::\n\n\n!! Note that I have set this chunk option `eval: false` to make sure this doesn't run again when I render the project (because it takes so long).\nIn my `_quarto.yml` I have the execute option `freeze: auto` set, which typically would mean that code is only re-run if I have changed the source.\nI want to avoid that behavior here, because I'm fiddling around with the source, but don't need this test to run again.\n\nAlso, it is important to supply the `filename` argument here to write the file.\nOtherwise, it will throw an error related to \"insufficient disk space\", because `terra` is trying to save the reclassed raster as a temp file.\nFor more info, read [this issue](https://github.com/rspatial/terra/issues/612) `terra`'s github repo.\n\nRecall that [1 byte = 8 bits = 2\\^8 (256) unique numbers](https://web.stanford.edu/class/cs101/bits-bytes.html), so the `datatype = \"INT2U\"` below means \"integer, 2 bytes, unsigned\".\nBack when I was dealing with the big raster size due to MUKEY values (see @sec-reclass ), I reclassed the raster in ArcGIS to allow us to use 16-bit encoding.\n16-bit would be 2 bytes so I think I should be able to stick with that for saving this EC raster.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n###### RECLASS for EC -------------------------------\n\n# this took a LONG time (50 minutes??)\n\nstart_reclass <- Sys.time()\n\nr_reclass <- classify(x = r,\n                      rcl = ec_mx, \n                      filename = \"E:/big-files-backup/ch03-sh-groups/test_reclass.tif\",\n                      datatype = \"INT2U\", \n                      overwrite = TRUE)\n\nend_reclass <- Sys.time() \n\nstart_reclass - end_reclass\n\n###### RECLASS for LEP -------------------------------\n\nstart_reclass <- Sys.time()\n\nr_reclass <- classify(x = r,\n                      rcl = lep_mx, \n                      filename = \"E:/big-files-backup/ch03-sh-groups/lep_reclass.tif\",\n                      datatype = \"INT2U\", \n                      overwrite = TRUE)\n\nend_reclass <- Sys.time() \n\nstart_reclass - end_reclass\n```\n:::\n\n\n### A note about file size\n\nAfter I saved this new raster, I checked the file size and it came to 0.1070863 GB (not bad!).\nI'd like to figure out how to make it go faster (if possible), but right now that's not my first priority.\n\n### Try reading and plotting new raster {#sec-ec1-plot}\n\nNote the min and max values here (1 and 5).\nThis means that I successfully reclassed all my raster values.\n\nReminder of what the numbers mean:\n\n-   1: EC is 0\n-   2: EC is \\>0, but \\<1\n-   3: EC = 1\n-   4: EC \\> 1\n-   5: NA value (meaning we are not including that area)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nec_rast <- rast(\"E:/big-files-backup/ch03-sh-groups/test_reclass.tif\")\n\nec_rast\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nclass       : SpatRaster \ndimensions  : 61033, 47668, 1  (nrow, ncol, nlyr)\nresolution  : 10, 10  (x, y)\nextent      : -91855, 384825, 2278555, 2888885  (xmin, xmax, ymin, ymax)\ncoord. ref. : NAD_1983_Albers \nsource      : test_reclass.tif \nname        : Reclass_tif1 \nmin value   :            1 \nmax value   :            5 \n```\n:::\n:::\n\n\nHaving issues with getting the colors to work in this plot, this gis.stackexchange thread seems helpful: https://gis.stackexchange.com/questions/435011/plotting-a-categorical-terra-raster-with-a-colour-map\n\nI had to update my version of `terra`, I had 1.4.XX, the method for doing colors described at the link above requires 1.5.50 or higher.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmycols <- data.frame(values = c(1:5), cols = hcl.colors(5, palette = \"viridis\"))\n\ncoltab(ec_rast) <- mycols\n\n# plot(x = ec_rast, legend = TRUE, plg=list(legend = c(\"EC=0\", \"EC>0 & <1\", \"EC=1\", \"EC>1\", \"Not Incl\")))\n\nplot(ec_rast, col = mycols, plg=list(legend = c(\"EC=0\", \"EC>0 & <1\", \"EC=1\", \"EC>1\", \"Not Incl\")))\n```\n\n::: {.cell-output-display}\n![](11-terra-experiment_files/figure-html/plot-try-1.png){width=672}\n:::\n:::\n\n\n## \n",
    "supporting": [
      "11-terra-experiment_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}