{
  "hash": "3ceef9efe6c9e4bc884f3c657538b16a",
  "result": {
    "markdown": "# Cluster pairwise comparisons\n\n## Overview\n\nNow that I have the validation data extracted and combined with the soil property data, I can run pairwise comparisons between clusters for each value of k (different \\# of clusters).\nThis may help us make an argument for why we chose one specific clustering (k=6 or k=8 for example) over others.\n\nAfter processing all the validation data, we ended up with \\~**140 points** to include (from CIG, NRCS-SHI, and NCSS-KSSL combined).\nDevine et al. had 396 points.\nThe first thing I want to do is see how the points are distributed across the clusters (and perhaps also on a map of MN) to assess if this is sufficient.\n\nI did identify a few sources for additional validation data, perhaps 20 additional points.\nNothing huge, but could add if we want to strengthen the case.\nNotes in 2022-12-30 log entry about this.\n\n\n::: {.cell}\n\n:::\n\n\n## Validation points per cluster\n\nHere I am illustrating how many independent validation points we have for each cluster assignment, for the different model options from k = 2 - 20.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-3-3.png){width=672}\n:::\n:::\n\n\n## Soil properties for pairwise comparisons\n\nBecause our validation data points are coming from different projects / datasets, we don't have exactly the same variables from each one.\nThis is a reminder of which variables exist in the three sources we used for validation points:\n\n-   KSSL : clay, bulk density, lep, awc, ec, cec, pH, carbonates, organic matter, (est org C)\n-   CIG: clay, bulk density, pH, carbonates, organic matter, (est org C)\n-   SHI: clay, bulk density, pH, organic matter\n\nIn summary: all three datasets include bulk density, pH, organic matter, and clay, and KSSL and CIG include carbonates.\nSo I think it makes sense to focus on plotting and doing pairwise comparisons with these variables specifically\n\n## Example pairwise: OM, k=6\n\nWorking out the steps I need to include in a function to do the pairwise comparisons.\nThis first chunk shows how I would do it if using one-way ANOVA followed by\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# test case k=6 version and organic matter\n\ntest_dat <- val_dat %>% \n  select(val_unit_id, k_6, om_loi, claytotal, source) %>% \n  drop_na(om_loi)\n\n# plot to see distributions \ntest_dat %>% \n  ggplot(aes(x = k_6, y = om_loi)) + \n  geom_boxplot() + \n  geom_point() + \n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntest_lm <- lm(formula = om_loi ~ k_6,\n   data = test_dat)\n\n# look at some diagnostic plots for our model \n# note homogeneity of variance looks sketchy\nperformance::check_model(test_lm, check = c(\"normality\", \"homogeneity\", \"linearity\"))\n```\n\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n:::\n\n\nThis shows how I would do pairwise t-tests with unpooled variance.\nThis might be more appropriate than the ANOVA approach I originally tried, because the diagnostic plots above suggest that we don't have homogeneity of variance for our validation dataset.\n\n*\"For some examples, one can use both the pooled t-procedure and the separate variances (non-pooled) t-procedure and obtain results that are close to each other. However, when the sample standard deviations are very different from each other, and the sample sizes are different, the separate variances 2-sample t-procedure is more reliable.\" Penn State [STAT 800 \"Applied Research Methods\"](https://online.stat.psu.edu/stat800/lesson/5/5.6/5.6.1/5.6.1.2) 5.6.1.2*\n\nNote that the p-value adjustment method here is \"holm\".\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# view the standard (console) output\nwith(test_dat, pairwise.t.test(om_loi, k_6, pool.sd = FALSE)) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPairwise comparisons using t tests with non-pooled SD \n\ndata:  om_loi and k_6 \n\n        clust_1 clust_2 clust_3 clust_4\nclust_2 0.03925 -       -       -      \nclust_3 0.03313 0.93472 -       -      \nclust_4 0.00150 0.00062 0.93472 -      \nclust_5 0.01717 0.93472 0.93472 0.06359\n\nP value adjustment method: holm \n```\n:::\n\n```{.r .cell-code}\n# tidy output, filter to significant comparisons only\nwith(test_dat, pairwise.t.test(om_loi, k_6, pool.sd = FALSE)) %>% broom::tidy() %>% \n  filter(p.value < 0.05)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"group1\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"group2\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"p.value\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"clust_2\",\"2\":\"clust_1\",\"3\":\"0.0392463502\"},{\"1\":\"clust_3\",\"2\":\"clust_1\",\"3\":\"0.0331318100\"},{\"1\":\"clust_4\",\"2\":\"clust_1\",\"3\":\"0.0015033758\"},{\"1\":\"clust_4\",\"2\":\"clust_2\",\"3\":\"0.0006245228\"},{\"1\":\"clust_5\",\"2\":\"clust_1\",\"3\":\"0.0171709059\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## Function for pairwise comparisons\n\nArguments: soil property and k option (model version / number of clusters) and validation dataframe.\n\nReturns: all pairwise comparisons in a dataframe\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncompare_clust_pairwise <- function(soil_var, k_opt, df) {\n  \n  dat_no_na <- df %>%\n    select(val_unit_id,\n           all_of(k_opt),\n           all_of(soil_var)) %>%\n    drop_na(all_of(soil_var))\n  \n  # can't do pairwise t-tests with only 1 obs in a \n  # group, so need to filter those out \n  \n  n_obs_per_cluster <- dat_no_na %>%\n    count(.data[[k_opt]])\n  \n  single_obs_clusters <- n_obs_per_cluster %>% \n    filter(n == 1) %>% \n    pull(.data[[k_opt]])\n  \n  if(length(single_obs_clusters) == 0){\n    \n    dat_subset <- dat_no_na\n    \n  }else{\n    \n    dat_subset <- dat_no_na %>% \n      filter(!(.data[[k_opt]] %in% single_obs_clusters))\n    \n  } \n  \n  soil_var_vec <- dat_subset %>% pull(soil_var)\n  clust_vec <- dat_subset %>% pull(k_opt)\n\n  pairs_df <- pairwise.t.test(soil_var_vec,\n                              clust_vec,\n                              pool.sd = FALSE) %>%\n    broom::tidy()\n\n  return(pairs_df)\n  \n}\n\nquiet_compare_clust_pairwise <- purrr::quietly(.f = compare_clust_pairwise)\n```\n:::\n\n\n## Example function output\n\nThis is what the pairwise function returns:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncompare_clust_pairwise(soil_var = \"ph1to1h2o\",\n                       k_opt = \"k_10\",\n                       df = val_dat) \n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"group1\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"group2\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"p.value\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"clust_3\",\"2\":\"clust_2\",\"3\":\"1.000000e+00\"},{\"1\":\"clust_4\",\"2\":\"clust_2\",\"3\":\"1.000000e+00\"},{\"1\":\"clust_4\",\"2\":\"clust_3\",\"3\":\"1.000000e+00\"},{\"1\":\"clust_5\",\"2\":\"clust_2\",\"3\":\"4.927891e-01\"},{\"1\":\"clust_5\",\"2\":\"clust_3\",\"3\":\"2.386927e-13\"},{\"1\":\"clust_5\",\"2\":\"clust_4\",\"3\":\"1.100042e-03\"},{\"1\":\"clust_6\",\"2\":\"clust_2\",\"3\":\"1.000000e+00\"},{\"1\":\"clust_6\",\"2\":\"clust_3\",\"3\":\"4.958657e-04\"},{\"1\":\"clust_6\",\"2\":\"clust_4\",\"3\":\"7.428253e-02\"},{\"1\":\"clust_6\",\"2\":\"clust_5\",\"3\":\"2.428431e-03\"},{\"1\":\"clust_7\",\"2\":\"clust_2\",\"3\":\"3.401141e-01\"},{\"1\":\"clust_7\",\"2\":\"clust_3\",\"3\":\"1.172084e-16\"},{\"1\":\"clust_7\",\"2\":\"clust_4\",\"3\":\"2.942181e-04\"},{\"1\":\"clust_7\",\"2\":\"clust_5\",\"3\":\"2.147610e-01\"},{\"1\":\"clust_7\",\"2\":\"clust_6\",\"3\":\"2.133414e-05\"},{\"1\":\"clust_8\",\"2\":\"clust_2\",\"3\":\"1.000000e+00\"},{\"1\":\"clust_8\",\"2\":\"clust_3\",\"3\":\"2.710695e-04\"},{\"1\":\"clust_8\",\"2\":\"clust_4\",\"3\":\"4.452335e-02\"},{\"1\":\"clust_8\",\"2\":\"clust_5\",\"3\":\"1.083645e-02\"},{\"1\":\"clust_8\",\"2\":\"clust_6\",\"3\":\"1.000000e+00\"},{\"1\":\"clust_8\",\"2\":\"clust_7\",\"3\":\"1.662644e-04\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## Run pairwise comparisons\n\nHere I create a dataframe to hold the results of the pairwise comparisons, then use `map2()` to iterate over the variables and cluster sizes, running all the tests.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# vars to compare on \nvar_names <- c(\"claytotal\", \"ph1to1h2o\", \"om_loi\", \"caco3\", \"dbthirdbar\")\n\n# all possible values of k (number of clusters)\ncluster_opts <- glue(\"k_{2:20}\")\n\n# create df with all combinations of var_names x clusters\ncomp_template <- tidyr::crossing(var_names, cluster_opts)\n\n# run the pairwise comparisons for each var and cluster size\ndiffs_df <- comp_template %>%\n  mutate(comps_all = map2(.x = var_names,\n                          .y = cluster_opts,\n                          .f = compare_clust_pairwise,\n                          df = val_dat))\n```\n:::\n\n\nNow need to count how many of the tests have an adjusted p-value \\< 0.05.\nAll of the p-values are adjusted with the Tukey method.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncount_sig_comps <- function(df){\n  \n  df %>% \n    filter(p.value<0.05) %>% \n    nrow()\n  \n}\n\nsig_diffs_df <- diffs_df %>%\n  mutate(n_sig_pair_diffs = map_int(comps_all, count_sig_comps)) %>% select(-comps_all) %>%\n  mutate(num_regions = as.numeric(str_extract(cluster_opts, \"[:digit:]+\")),\n         possible_comps = (num_regions * (num_regions - 1)) / 2)\n\nwrite_csv(sig_diffs_df, file = \"data/original_pairwise_comparisons.csv\")\n```\n:::\n\n\n## Plot comparisons\n\n### All clusters\n\nFirst we can look at a plot of all the cluster sizes, from 2-20.\nFor carbonates, bulk density, and organic matter, this plot seems to level off around k=11.\nFor clay and pH, we continue to see an increase in the number of significant contrasts beyond k=11.\nThis pattern is more apparent when looking at the smoothed trends in the second plot here.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n:::\n\n\nFor context, this plot shows a black line for the total number of **possible** contrasts\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nTwo other ways to contextualize the number of significant contrasts: 1) with a table, and 2) with a plot showing how the % significant contrasts (as a function of total possible) changes as the number of clusters goes up.\n\nFor the % significant contrasts, we see local maxima at k = 8 and k = 11, although the one at k = 11 is slightly smaller.\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"num_regions\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sig_comps\"],\"name\":[2],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"possible_comps\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"percent_sig\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"alpha_5perc\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2\",\"2\":\"4\",\"3\":\"5\",\"4\":\"80\",\"5\":\"0\"},{\"1\":\"3\",\"2\":\"11\",\"3\":\"15\",\"4\":\"73\",\"5\":\"1\"},{\"1\":\"4\",\"2\":\"20\",\"3\":\"30\",\"4\":\"67\",\"5\":\"2\"},{\"1\":\"5\",\"2\":\"24\",\"3\":\"50\",\"4\":\"48\",\"5\":\"2\"},{\"1\":\"6\",\"2\":\"31\",\"3\":\"75\",\"4\":\"41\",\"5\":\"4\"},{\"1\":\"7\",\"2\":\"34\",\"3\":\"105\",\"4\":\"32\",\"5\":\"5\"},{\"1\":\"8\",\"2\":\"41\",\"3\":\"140\",\"4\":\"29\",\"5\":\"7\"},{\"1\":\"9\",\"2\":\"41\",\"3\":\"180\",\"4\":\"23\",\"5\":\"9\"},{\"1\":\"10\",\"2\":\"43\",\"3\":\"225\",\"4\":\"19\",\"5\":\"11\"},{\"1\":\"11\",\"2\":\"53\",\"3\":\"275\",\"4\":\"19\",\"5\":\"14\"},{\"1\":\"12\",\"2\":\"63\",\"3\":\"330\",\"4\":\"19\",\"5\":\"16\"},{\"1\":\"13\",\"2\":\"61\",\"3\":\"390\",\"4\":\"16\",\"5\":\"20\"},{\"1\":\"14\",\"2\":\"74\",\"3\":\"455\",\"4\":\"16\",\"5\":\"23\"},{\"1\":\"15\",\"2\":\"71\",\"3\":\"525\",\"4\":\"14\",\"5\":\"26\"},{\"1\":\"16\",\"2\":\"67\",\"3\":\"600\",\"4\":\"11\",\"5\":\"30\"},{\"1\":\"17\",\"2\":\"81\",\"3\":\"680\",\"4\":\"12\",\"5\":\"34\"},{\"1\":\"18\",\"2\":\"76\",\"3\":\"765\",\"4\":\"10\",\"5\":\"38\"},{\"1\":\"19\",\"2\":\"82\",\"3\":\"855\",\"4\":\"10\",\"5\":\"43\"},{\"1\":\"20\",\"2\":\"76\",\"3\":\"950\",\"4\":\"8\",\"5\":\"48\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n### k = 5-15\n\nLet's look more closely at our model options in the middle range, from 5-15.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\nDropping the \"total possible\" line makes marginal changes from one model to another easier to see (below).\nWhat I notice about the graph below:\n\n-   Increase in number of significant contrasts from k=7 to k=8, driven by clay, ph, bulk density\n-   No sig contrasts added from k=8 to k=9, and only a couple added from bulk density from k=9 to k=10\n-   From k=10 to k=11. we add significant contrasts in pH, bulk density, organic matter, and clay\n-   from k=11 to k=12, big jump in contrasts driven by pH\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](20-cluster-pairwise-comp_files/figure-html/unnamed-chunk-14-2.png){width=672}\n:::\n:::\n\n\n### Clay and OM contrasts for k = 7-12\n\nFrom the plots above, we've learned that differences in clay and organic matter are primarily responsible for the significant contrasts we see being added from the k=7 model up to the k=12 model.\nIn particular, we know that the move from the k=10 model to k=11 model results in an increased % of significant contrasts in these two variables (see immediately preceding plot)\n\nThe table below illustrates the number of significant contrasts for each model version in the k=7-12 range, for clay and organic matter.\nNote that there are 10 significant contrasts added for clay when going from k=10 to k=11.\n\nI was curious to know why this was, so I looked at some of the alluvial plots in `_refs`.\nThe dimensions of these make it hard to display them legibly in HTML format, but looking at `alluvial_k8-11.pdf` , I can see that the new cluster added in k_11 is a relatively small (n=200 mapunits) group of the highest clay soils which also have EC \\~1 and 3% carbonates.\nThis is also illustrated in the k=11 map grids in the folllowing chapter.\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"cluster_opts\"],\"name\":[1],\"type\":[\"glue\"],\"align\":[\"right\"]},{\"label\":[\"claytotal\"],\"name\":[2],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"om_loi\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"k_10\",\"2\":\"17\",\"3\":\"3\"},{\"1\":\"k_11\",\"2\":\"21\",\"3\":\"5\"},{\"1\":\"k_12\",\"2\":\"23\",\"3\":\"5\"},{\"1\":\"k_7\",\"2\":\"14\",\"3\":\"3\"},{\"1\":\"k_8\",\"2\":\"17\",\"3\":\"3\"},{\"1\":\"k_9\",\"2\":\"17\",\"3\":\"3\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n",
    "supporting": [
      "20-cluster-pairwise-comp_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}